// SpreadsheetService.gs
// スプレッドシートの読み書きユーティリティ

const SpreadsheetService = (function() {

  /**
   * 全生徒一覧を取得
   */
  function fetchStudentsList() {
    try {
      // スプレッドシートを開く
      const ss = SpreadsheetApp.openById(SETTINGS.SS_IDS.STUDENT_LIST);

      // シートを取得（GID指定がある場合はそれを優先）
      let sheet;
      if (SETTINGS.SHEET_GIDS.STUDENTS) {
        // GIDでシートを取得
        const sheets = ss.getSheets();
        sheet = sheets.find(function(s) {
          return s.getSheetId().toString() === SETTINGS.SHEET_GIDS.STUDENTS.toString();
        });

        if (!sheet) {
          throw new Error('指定されたGIDのシートが見つかりません: ' + SETTINGS.SHEET_GIDS.STUDENTS);
        }
      } else {

        // シート名で取得
          sheet = ss.getSheetByName(SETTINGS.SHEET_NAMES.STUDENTS);
          if (!sheet) {
            // シート名が見つからない場合は最初のシートを使用
            sheet = ss.getSheets()[0];
          }
      }

      // D列2行目以降から生徒データを取得
      // D列 = 4列目（0-indexed で 3）
  const lastRow = sheet.getLastRow();

      const students = [];

      // 2行目以降のデータを取得（1行目はヘッダーと仮定）
      if (lastRow >= 2) {
        // D列のみ取得（範囲: D2:D[最終行]）
  const data = sheet.getRange(2, 4, lastRow - 1, 1).getValues();

        for (let i = 0; i < data.length; i++) {
          const studentName = data[i][0];
          // 行データ取得

          if (studentName && studentName.toString().trim()) {
            students.push({
              id: (i + 1).toString().padStart(3, '0'), // 001, 002, ... の形式でIDを生成
              name: studentName.toString().trim(),
              contact: '' // 連絡先は別列にある場合は後で追加
            });
          }
        }
      }

  // 生徒データ取得完了

      return students;

    } catch (e) {
      // エラーはログに残して上位に投げる
      Logger.log('fetchStudentsList エラー: ' + e.message);
      throw e;
    }
  }

  /**
   * 特定生徒の目標と前回レッスンを取得
   * @param {string} studentId - 生徒ID (例: "001")
   * @returns {object} { goals: [...], lastLesson: {...} }
   */
  function fetchStudentGoalsAndHistory(studentId) {
    try {
      // 生徒名を取得
      const students = fetchStudentsList();
      const student = students.find(s => s.id === studentId);
      if (!student) {
        throw new Error('生徒が見つかりません: ID=' + studentId);
      }

      const studentName = student.name;

      // 生徒のスプレッドシートを開く
      // フォルダから検索、または固定のスプレッドシートIDを使用
      let goalsSs;
      try {
        goalsSs = findStudentSpreadsheet(studentName);
      } catch (e) {
        Logger.log('生徒スプレッドシートが見つかりません: ' + e.message);
        // フォールバック: GOAL_MANAGEMENTを使用
        goalsSs = SpreadsheetApp.openById(SETTINGS.SS_IDS.GOAL_MANAGEMENT);
      }

      // 「本日のレッスンの作戦」シートを取得
      const goalsSheet = goalsSs.getSheetByName(SETTINGS.SHEET_NAMES.LESSON_STRATEGY);
      if (!goalsSheet) {
        Logger.log('シート「本日のレッスンの作戦」が見つかりません');
        return { goals: [], lastLesson: null };
      }

      // データを取得（3行目以降、1-2行目はヘッダー）
      const lastRow = goalsSheet.getLastRow();
      if (lastRow < 3) {
        return { goals: [], lastLesson: null };
      }

      // B列(2), C列(3), G列(7), L列(12), M列(13)を取得
      const data = goalsSheet.getRange(3, 1, lastRow - 2, 13).getValues();

      const goals = [];
      for (let i = 0; i < data.length; i++) {
        const category = data[i][1]; // B列（インデックス1）
        const item = data[i][2];     // C列（インデックス2）
        const goal = data[i][6];     // G列（インデックス6）
        const lastStrategy = data[i][11]; // L列（インデックス11）
        const lastResult = data[i][12];   // M列（インデックス12）

        // カテゴリと項目が存在する行のみ追加
        if (category && item) {
          goals.push({
            category: category.toString().trim(),
            item: item.toString().trim(),
            goal: goal ? goal.toString().trim() : '',
            lastStrategy: lastStrategy ? lastStrategy.toString().trim() : '',
            lastResult: lastResult ? lastResult.toString().trim() : ''
          });
        }
      }

      return {
        goals: goals,
        lastLesson: null // 前回レッスンは目標シートに含まれるため不要
      };

    } catch (e) {
      Logger.log('fetchStudentGoalsAndHistory エラー: ' + e.message);
      throw e;
    }
  }

  /**
   * 生徒名から該当するスプレッドシートを検索
   * @param {string} studentName - 生徒名
   * @returns {Spreadsheet} スプレッドシート
   */
  function findStudentSpreadsheet(studentName) {
    // フォルダIDが設定されている場合はフォルダ内を検索
    if (SETTINGS.DRIVE.GOAL_SHEETS_FOLDER_ID) {
      const folder = DriveApp.getFolderById(SETTINGS.DRIVE.GOAL_SHEETS_FOLDER_ID);
      const fileName = 'レッスン情報_' + studentName;

      const files = folder.getFilesByName(fileName);
      if (files.hasNext()) {
        const file = files.next();
        return SpreadsheetApp.openById(file.getId());
      }
    }

    // 見つからない場合はエラー
    throw new Error('生徒のスプレッドシートが見つかりません: ' + studentName);
  }

  /**
   * 作戦をスプレッドシートに保存
   * 生徒ごとのスプレッドシートの「本日のレッスンの作戦」シートのJ列に書き込む
   * @param {object} data - { students: [{ id, itemStrategies: [...] }] }
   */
  function writeStrategy(data) {
    try {
      // 生徒一覧を取得
      const students = fetchStudentsList();

      // 各生徒の作戦を保存
      data.students.forEach(student => {
        if (!student.id || !student.itemStrategies || student.itemStrategies.length === 0) {
          return;
        }

        // 生徒名を取得
        const studentInfo = students.find(s => s.id === student.id);
        if (!studentInfo) {
          Logger.log('生徒が見つかりません: ID=' + student.id);
          return;
        }

        try {
          // 生徒のスプレッドシートを開く
          const goalsSs = findStudentSpreadsheet(studentInfo.name);
          const goalsSheet = goalsSs.getSheetByName(SETTINGS.SHEET_NAMES.LESSON_STRATEGY);

          if (!goalsSheet) {
            Logger.log('シート「本日のレッスンの作戦」が見つかりません: ' + studentInfo.name);
            return;
          }

          // シートのデータを取得（3行目以降）
          const lastRow = goalsSheet.getLastRow();
          if (lastRow < 3) {
            Logger.log('データ行がありません: ' + studentInfo.name);
            return;
          }

          // B列、C列、J列を含む範囲を取得
          const data = goalsSheet.getRange(3, 1, lastRow - 2, 10).getValues();

          // 各作戦について、該当する行を探してJ列に書き込む
          student.itemStrategies.forEach(item => {
            for (let i = 0; i < data.length; i++) {
              const category = data[i][1] ? data[i][1].toString().trim() : ''; // B列
              const itemName = data[i][2] ? data[i][2].toString().trim() : '';  // C列

              // カテゴリと項目が一致したら、その行のJ列に作戦を書き込む
              if (category === item.category && itemName === item.item) {
                const rowNumber = i + 3; // 3行目から開始
                goalsSheet.getRange(rowNumber, 10).setValue(item.strategy); // J列 = 10列目
                break;
              }
            }
          });

          Logger.log('作戦を保存しました: ' + studentInfo.name);
        } catch (e) {
          Logger.log('作戦保存エラー (' + studentInfo.name + '): ' + e.message);
        }
      });

    } catch (e) {
      Logger.log('writeStrategy エラー: ' + e.message);
      throw e;
    }
  }

  /**
   * 最新の作戦データを取得
   */
  function fetchLatestStrategy() {
    const ss = SpreadsheetApp.openById(SETTINGS.SS_IDS.FEEDBACK);
    const sheet = ss.getSheetByName(SETTINGS.SHEET_NAMES.FEEDBACK);

    const data = sheet.getDataRange().getValues();
    const strategies = [];

    // 最新の日付を特定
    let latestDate = null;
    for (let i = data.length - 1; i >= 1; i--) {
      if (data[i][3] === '作戦') {
        latestDate = data[i][0];
        break;
      }
    }

    if (!latestDate) return { date: null, students: [] };

    // 同じ日付の作戦をすべて取得
    for (let i = 1; i < data.length; i++) {
      const rowDate = data[i][0];
      if (data[i][3] === '作戦' &&
          rowDate.getTime() === latestDate.getTime()) {
        strategies.push({
          studentId: data[i][1],
          strategy: data[i][2],
          feedback: data[i][4] || ''
        });
      }
    }

    return {
      date: Utilities.formatDate(latestDate, 'JST', 'yyyy/MM/dd'),
      students: strategies
    };
  }

  /**
   * 振り返りを保存
   * スプレッドシート構造:
   * A列: 日付, B列: 生徒ID, C列: レッスン内容, D列: ふりかえり, E列: 次回やること
   */
  function writeFeedback(data) {
    const ss = SpreadsheetApp.openById(SETTINGS.SS_IDS.FEEDBACK);
    const sheet = ss.getSheetByName(SETTINGS.SHEET_NAMES.FEEDBACK);

    const timestamp = new Date();

    // 各生徒の振り返りを保存
    data.students.forEach(student => {
      if (student.id) {
        sheet.appendRow([
          timestamp,
          student.id,
          student.lessonContent || '',
          student.lessonFeedback || '',
          student.lessonNext || ''
        ]);
      }
    });
  }

  // 公開API
  return {
    fetchStudentsList: fetchStudentsList,
    fetchStudentGoalsAndHistory: fetchStudentGoalsAndHistory,
    writeStrategy: writeStrategy,
    fetchLatestStrategy: fetchLatestStrategy,
    writeFeedback: writeFeedback
  };
})();
