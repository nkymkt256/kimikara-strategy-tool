# レッスン管理システム (GAS Webアプリ版) 構成案

ご提示いただいた「実装アイデアドキュメント」に基づき、Google Apps Script (GAS) の Web アプリケーションとして構築する際のファイル構成とアーキテクチャ案をまとめます。

## 1. ファイル構成の考え方（シンプル版）

「ファイルが多い」というご意見に対応して、構成をよりシンプルにした案です。

### HTML の分離（最小限）

- `index.html` — すべてのページの「器」となるメイン HTML。共通 CSS とクライアントサイド JS をこのファイル内にインラインで配置します。
- `Header.html` — 共通ナビゲーションバーの断片。
- `Page-*.html` — 各ページ固有のコンテンツ断片。

### GS (.gs) の分離

関心事ごとにファイルを分けます（例: スプレッドシート処理、スライド処理など）。`Main.gs` がサーバーサイドの起点、`index.html` がクライアントサイドの起点、という責務分離を明確にします。

## 2. 提案ファイル構成（シンプル版）

```
.
├── appsscript.json            # プロジェクトのマニフェスト（スコープ、GCP連携）
├── Settings.gs                # ★ 設定値（ID、APIキー等）
├── Main.gs                    # ★ Webアプリの起点（doGet、ページ読込）
├── index.html                 # ★ メイン HTML（SPA コンテナ + CSS + クライアント JS）
├── Header.html                # 共通ヘッダー（ナビ）
├── Page-StrategyInput.html    # ページ: レッスン当日作戦入力（必須）
├── Page-StrategyView.html     # ページ: レッスン当日作戦表示（必須）
├── Page-GoalManagement.html   # ページ: 目標管理（オプショナル）
├── SpreadsheetService.gs      # サーバーサイド: スプレッドシート処理
├── SlideService.gs            # サーバーサイド: Google スライド処理
├── DriveService.gs            # サーバーサイド: Google ドライブ処理
└── GeminiService.gs           # サーバーサイド: Gemini（Vertex AI）関連処理
```

## 3. クライアント JS と サーバー GS の分離について

GAS の仕組み上、クライアント側で動くスクリプト（`index.html` 内の `<script>`）と、サーバー側で動く `.gs` ファイルは別物です。`JavaScript.html` を `Main.gs` に移すような実行方法はできません。

そのため、ファイル数を抑えたい場合は、`index.html` にクライアント側のコードをインライン化するのが現実的です。

## 4. ページ遷移（ナビゲーション）の実装方法

この Web アプリは SPA（Single Page Application） として実装するのが扱いやすいです。おおまかなフロー：

1. `doGet()` が `index.html` を返す。
2. `index.html` は `Header.html` を読み込み、CSS/JS を解釈する。
3. ナビゲーションのリンクをクリック → クライアント側のイベントハンドラが `event.preventDefault()` を行う。
4. `google.script.run.withSuccessHandler(updatePage).loadPage(pageName)` を呼び、サーバー側（`Main.gs`）から該当する `Page-*.html` を取得する。
5. 受け取った HTML を `<main>` の `innerHTML` にセットして画面を切り替える。

これによりページ全体をリロードせずに高速な画面切替が可能になります。

## 5. GCP 連携（Gemini API 等）

Gemini（Vertex AI）や Google Slides API（Advanced Service）を使う場合は GCP プロジェクトの連携が必要です。

- GAS のプロジェクト設定で GCP プロジェクト番号を設定する。
- `Settings.gs` に `PROJECT_ID` 等を定義する。
- GCP コンソールで対象 API（Vertex AI、Slides API など）を有効化する。
- `appsscript.json` に必要な OAuth スコープや `cloudProject` を設定する。

## 6. データ設計に関する提案

「生徒ごとにスプレッドシートファイルを作る」設計は、生徒数の増加で管理が大変になり、API 呼び出し量（Quota）にも影響します。代替として単一ファイル内で生徒ごとにデータを管理する設計を推奨します。

メリット:

- 特定生徒のデータだけをスプレッドシートのフィルタ／クエリで取得可能。パフォーマンス改善。
- ファイル管理が簡単になる。
- API 呼び出し回数を節約できる。

## 各ファイルの解説

### サーバーサイド（.gs）

#### Settings.gs

- 役割: プロジェクト全体の設定（`SETTINGS` グローバルオブジェクト）
- 含む: GCP プロジェクト ID、スプレッドシート ID、シート名、Drive フォルダ ID など

#### Main.gs

- 役割: サーバーサイドのコントローラ（エントリ）
- 主な関数:
  - `doGet()` — `index.html` を返す
  - `include(path)` — HTML 断片を読み込むヘルパ
  - `loadPage(pageName)` — 各 `Page-*.html` を返す

依存: `SpreadsheetService.gs`, `GeminiService.gs`, `SlideService.gs`, `HtmlService`（GAS 組み込み）

#### SpreadsheetService.gs

- 役割: Google スプレッドシートの CRUD を担う
- 例: `getStudentsList()`, `saveFeedback()`, `getStudentGoals()` など

#### GeminiService.gs

- 役割: Gemini（Vertex AI） API 呼び出しをラップ
- 例: `generateContent(prompt)` — `UrlFetchApp` 経由で API を呼ぶ

#### SlideService.gs

- 役割: Google スライドの生成・更新
- 例: `createFeedbackSlide(data)` — Slides API（Advanced Service）でスライドを作る

#### DriveService.gs

- 役割: Drive 操作のユーティリティ（ファイル移動など）

### クライアントサイド（.html）

#### index.html

- 役割: SPA のコンテナ。CSS とクライアント JS をインライン化。
- 機能:
  - `<header>` に `Header.html` を読み込み
  - `<main>` に `Page-*.html` の内容を挿入
  - `google.script.run` でサーバー関数を呼び出す
  - `handleNavClick()`, `handleSaveFeedback()` 等のイベント処理
  - `sessionStorage` / `localStorage` を一部利用して画面間のデータ受け渡しや再読み込み耐性を確保

#### Header.html

- 役割: 共通ナビゲーション（`data-page` 属性を持たせ、クライアント JS がどのページを読み込むか判定）

#### Page-*.html

- 役割: 各画面の断片 HTML（フォーム、表示パネル等）

### 設定ファイル: appsscript.json

- 役割: プロジェクトマニフェスト
- 設定例:
  - `dependencies.enabledAdvancedServices`（Slides、Drive の有効化）
  - `oauthScopes`（Spreadsheet, Slides, UrlFetch 等）
  - `cloudProject`（GCP プロジェクト番号の紐付け）

---

以上が「GAS Web アプリ版 レッスン管理システム」のシンプル構成案です。必要であれば、この案をベースに具体的なファイルテンプレート（`Main.gs` のひな形、`index.html` のベース、`Settings.gs` の定義例など）を生成します。どれを優先して出力しましょうか？
