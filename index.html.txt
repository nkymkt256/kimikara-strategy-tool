<!-- index.html (SPA container) -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>ãƒ¬ãƒƒã‚¹ãƒ³ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* ========================================
       å…±é€šã‚¹ã‚¿ã‚¤ãƒ«
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #ffffffff;
    }

    h2 {
      color: #6C757D;
      margin-bottom: 20px;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }

    h3 {
      color: #34495e;
      margin: 20px 0 10px;
    }

    h4 {
      color: #7f8c8d;
      margin: 10px 0 5px;
      font-size: 0.9em;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }

    select, input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
    }

    textarea {
      resize: vertical;
      font-family: inherit;
    }

    /* ãƒœã‚¿ãƒ³ */
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    button:not(.primary-btn) {
      background: #95a5a6;
      color: white;
    }

    .primary-btn {
      background: #3498db;
      color: white;
    }

    .action-buttons {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }

    /* ç”Ÿå¾’ãƒ•ã‚©ãƒ¼ãƒ ã‚³ãƒ³ãƒ†ãƒŠï¼ˆæ¨ªä¸¦ã³å¯¾å¿œï¼‰ */
    #students-area,
    #students-view-area {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    /* ç”Ÿå¾’ãƒ•ã‚©ãƒ¼ãƒ  */
    .student-form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 350px;
    }

    /* ç”Ÿå¾’ãŒ2äººä»¥ä¸Šã®å ´åˆã¯2åˆ—è¡¨ç¤º */
    #students-area:has(.student-form:nth-child(2)) .student-form,
    #students-view-area:has(.student-form:nth-child(2)) .student-form {
      max-width: calc(50% - 10px);
    }

    /* ç”Ÿå¾’ãŒ1äººã®å ´åˆã¯æ¨ªå¹…ã„ã£ã±ã„ */
    #students-area:has(.student-form:only-child) .student-form,
    #students-view-area:has(.student-form:only-child) .student-form {
      max-width: 100%;
    }

    .student-info {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .info-section {
      background: #f9f9f9;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #3498db;
    }

    .info-section p {
      margin: 5px 0;
      font-size: 14px;
    }

    /* ã‚«ãƒ†ã‚´ãƒªåˆ¥ç›®æ¨™è¡¨ç¤º */
    .goal-category {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .category-title {
      color: #2c3e50;
      margin: 0 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
      font-size: 1.1em;
    }

    .goal-item {
      background: white;
      margin: 10px 0;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      transition: all 0.2s;
    }

    .goal-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-color: #3498db;
    }

    .goal-item-empty {
      opacity: 0.7;
      background: #fafafa;
    }

    .goal-item-header {
      margin-bottom: 8px;
      color: #34495e;
    }

    .goal-item-content p {
      margin: 6px 0;
      font-size: 13px;
      line-height: 1.5;
    }

    .goal-item-content .label {
      display: inline-block;
      font-weight: 600;
      color: #555;
      min-width: 100px;
    }

    .goal-item-content .no-goal {
      color: #999;
      font-style: italic;
    }

    .item-strategy-input {
      width: 100%;
      min-height: 50px;
      margin-top: 5px;
    }

    /* ä½œæˆ¦è¡¨ç¤ºï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰ */
    .strategy-content.readonly {
      background: #f0f8ff;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      border: 1px solid #d0e7f9;
      font-size: 14px;
      line-height: 1.5;
      margin: 8px 0;
    }

    .section {
      margin: 10px 0;
    }

    .strategy-container {
      margin-top: 20px;
      border-top: 2px solid #3498db;
      border-radius: 8px;
    }

    /* ä½œæˆ¦å…¥åŠ›ãƒšãƒ¼ã‚¸ã®ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¼ãƒ‰é¢¨ã‚¹ã‚¿ã‚¤ãƒ«
       - ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å†…ã®ã¿é©ç”¨ã—ã¦ä»–ãƒšãƒ¼ã‚¸ã«å½±éŸ¿ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ */
    .page-content .strategy-input-container .strategy-container {
      border: 1px solid #e0e6ee;
      border-radius: 12px;
      padding: 24px;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(16,24,40,0.04);
      min-height: 70vh; /* ã‹ãªã‚Šä¸‹ã¾ã§é«˜ã•ã‚’ç¢ºä¿ */
      display: flex;
      flex-direction: column;
    }

    /* ä½œæˆ¦è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ */
    .strategy-card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 5px solid #3498db;
    }

    .strategy-content.readonly {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
      border: 1px solid #d0e7f9;
    }

    .section {
      margin: 15px 0;
    }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
    #save-status, #generation-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-weight: 600;
    }

    .date-display {
      background: #ecf0f1;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-weight: 600;
      color: #2c3e50;
    }

    /* Toasté€šçŸ¥ */
    .toast {
      position: fixed;
      bottom: -100px;
      right: 20px;
      background: #2ecc71;
      color: white;
      padding: 15px 25px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9999;
      transition: bottom 0.3s ease;
      font-weight: 600;
    }

    .toast.show {
      bottom: 20px;
    }

    /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      padding: 40px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spin-icon {
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: #666;
      font-size: 16px;
      font-weight: 500;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .student-form {
        padding: 15px;
        max-width: 100%; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã¯1åˆ—è¡¨ç¤º */
        min-width: 100%;
      }

      .strategy-card {
        padding: 15px;
      }

      button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="container">
    <header><?!= include('Header') ?></header>
    <main id="app"><!-- å‹•çš„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ --> </main>
  </div>
  <style>
    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ãƒŠå¹…å›ºå®š */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 40px;
      box-sizing: border-box;
    }

    /* æŒ¿å…¥ã•ã‚Œã‚‹ãƒšãƒ¼ã‚¸æœ¬ä½“ã®ä½™ç™½ã¯ .page-content ã«ä»˜ä¸ã™ã‚‹ */
    .page-content {
      box-sizing: border-box;
    }
  </style>
  <script>
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ========================================
    let studentsListCache = []; // ç”Ÿå¾’ä¸€è¦§ã‚­ãƒ£ãƒƒã‚·ãƒ¥
    let studentGoalsCache = {}; // ç”Ÿå¾’ã”ã¨ã®ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ£ãƒƒã‚·ãƒ¥ { studentId: { goals: [...] } }
    const STORAGE_KEY = 'lesson_strategy_draft';

    // ========================================
    // åˆæœŸåŒ–
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      restoreStrategy();
    });

    // ========================================
    // ãƒšãƒ¼ã‚¸é·ç§»å‡¦ç†
    // ========================================
    function handleNavClick(event) {
      event.preventDefault();
      const pageName = event.target.getAttribute('data-page');
      if (!pageName) return;

      google.script.run
        .withSuccessHandler(updatePage)
        .withFailureHandler(showError)
        .loadPage(pageName);
    }

    function updatePage(html) {
      // æŒ¿å…¥ãƒšãƒ¼ã‚¸ã«å…±é€šã®ä½™ç™½ã‚’ä¸ãˆã‚‹ãŸã‚ã€.page-content ã§ãƒ©ãƒƒãƒ—ã—ã¦æŒ¿å…¥
      document.getElementById('app').innerHTML = `<div class="page-content">${html}</div>`;

      // ãƒšãƒ¼ã‚¸é·ç§»æ™‚ã«ä¸€ç•ªä¸Šã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      window.scrollTo(0, 0);

      // ãƒšãƒ¼ã‚¸å›ºæœ‰ã®åˆæœŸåŒ–
      if (html.includes('strategy-input-container')) {
        // ä½œæˆ¦å…¥åŠ›ãƒšãƒ¼ã‚¸: ç”Ÿå¾’ä¸€è¦§ã‚’å–å¾—ã—ã¦ã‹ã‚‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
        showLoadingOnStrategyInput();
        loadStudentsList(function() {
          // ç”Ÿå¾’ä¸€è¦§ã®å–å¾—ãŒå®Œäº†ã—ãŸã‚‰ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è§£é™¤ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
          hideLoadingOnStrategyInput();
          restoreStrategy();
        });
      } else if (html.includes('strategy-view-container')) {
        // ä½œæˆ¦è¡¨ç¤ºãƒšãƒ¼ã‚¸: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ä½œæˆ¦ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
        loadLatestStrategy();
      }
    }

    // ========================================
    // ã‚¹ãƒ†ãƒƒãƒ—1: ä½œæˆ¦å…¥åŠ›æ©Ÿèƒ½
    // ========================================

    // ä½œæˆ¦å…¥åŠ›ãƒšãƒ¼ã‚¸ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã‚’è¿½åŠ 
    function showLoadingOnStrategyInput() {
      const strategyContainer = document.querySelector('.strategy-input-container .strategy-container');
      if (!strategyContainer) return;

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤ºã«ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡¨ç¤º
      strategyContainer.style.display = 'none';

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-container';
      loadingDiv.id = 'students-loading';
      loadingDiv.innerHTML = `
        <div class="loading-spinner"></div>
        <div class="loading-text">ç”Ÿå¾’ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
      `;

      // strategy-containerã®ç›´å‰ã«æŒ¿å…¥
      strategyContainer.parentNode.insertBefore(loadingDiv, strategyContainer);
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã«ã—ã¦ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
    function hideLoadingOnStrategyInput() {
      const loadingDiv = document.getElementById('students-loading');
      if (loadingDiv) {
        loadingDiv.remove();
      }

      const strategyContainer = document.querySelector('.strategy-input-container .strategy-container');
      if (strategyContainer) {
        strategyContainer.style.display = 'flex';
      }
    }

    // ç”Ÿå¾’æ•°å¤‰æ›´æ™‚ã®å‡¦ç†
    function handleStudentCountChange() {
      const count = parseInt(document.getElementById('student-count').value);
      const container = document.getElementById('students-area');
      const template = document.getElementById('student-form-template');

      if (!count || count < 1 || count > 5) {
        container.innerHTML = '';
        document.getElementById('save-strategy-btn').disabled = true;
        return;
      }

      container.innerHTML = '';

      for (let i = 0; i < count; i++) {
        const clone = template.content.cloneNode(true);
        const formDiv = clone.querySelector('.student-form');
        formDiv.setAttribute('data-index', i);
        clone.querySelector('.student-number').textContent = i + 1;

        // ç”Ÿå¾’é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«é¸æŠè‚¢ã‚’è¿½åŠ 
        const select = clone.querySelector('.student-select');
        studentsListCache.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = student.name;
          select.appendChild(option);
        });

        container.appendChild(clone);
      }

      document.getElementById('save-strategy-btn').disabled = false;
    }

    // ç”Ÿå¾’é¸æŠæ™‚ã«ãƒ‡ãƒ¼ã‚¿å–å¾—
    function loadStudentData(selectElement) {
      const studentId = selectElement.value;
      if (!studentId) return;

      const formDiv = selectElement.closest('.student-form');
      const infoDiv = formDiv.querySelector('.student-info');

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
      if (studentGoalsCache[studentId]) {
        displayStudentData(formDiv, studentGoalsCache[studentId]);
        infoDiv.style.display = 'block';
        return;
      }

      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã‘ã‚Œã°ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
      google.script.run
        .withSuccessHandler(function(data) {
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          studentGoalsCache[studentId] = data;
          displayStudentData(formDiv, data);
          infoDiv.style.display = 'block';
        })
        .withFailureHandler(showError)
        .getStudentData(studentId);
    }

    // ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆã‚«ãƒ†ã‚´ãƒªåˆ¥ã®ç›®æ¨™æ§‹é€ ã«å¯¾å¿œï¼‰
    function displayStudentData(formDiv, data) {
      const goalsContainer = formDiv.querySelector('.student-goals-container');

      if (!data.goals || data.goals.length === 0) {
        goalsContainer.innerHTML = '<p style="color: #999;">ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const categorized = {};
      data.goals.forEach(item => {
        if (!categorized[item.category]) {
          categorized[item.category] = [];
        }
        categorized[item.category].push(item);
      });

      // HTMLã‚’æ§‹ç¯‰
      let html = '';
      for (const category in categorized) {
        html += `
          <div class="goal-category">
            <h4 class="category-title">${category}</h4>
        `;

        categorized[category].forEach(item => {
          const hasGoal = item.goal && item.goal.trim();
          const itemClass = hasGoal ? 'goal-item' : 'goal-item goal-item-empty';

          html += `
            <div class="${itemClass}">
              <div class="goal-item-header">
                <strong>${item.item}</strong>
              </div>
              <div class="goal-item-content">
                ${hasGoal ? `<p><span class="label">ç›®æ¨™:</span> ${item.goal}</p>` : '<p class="no-goal">ç›®æ¨™æœªè¨­å®š</p>'}
                ${item.lastStrategy ? `<p><span class="label">å‰å›ã®ä½œæˆ¦:</span> ${item.lastStrategy}</p>` : ''}
                ${item.lastResult ? `<p><span class="label">å‰å›ã®çµæœ:</span> ${item.lastResult}</p>` : ''}
                <div class="form-group">
                  <label>ä»Šæ—¥ã®ä½œæˆ¦:</label>
                  <textarea
                    class="item-strategy-input"
                    data-category="${category}"
                    data-item="${item.item}"
                    rows="2"
                    placeholder="ã“ã®é …ç›®ã«é–¢ã™ã‚‹ä½œæˆ¦ã‚’å…¥åŠ›..."
                    oninput="autoSaveStrategy()"
                  ></textarea>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      goalsContainer.innerHTML = html;
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è‡ªå‹•ä¿å­˜
    function autoSaveStrategy() {
      const data = collectStrategyData();
      if (data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    function clearStrategyCache() {
      localStorage.removeItem(STORAGE_KEY);
      console.log('ä½œæˆ¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰å¾©å…ƒ
    function restoreStrategy() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return;

      try {
        const data = JSON.parse(saved);
        // ç”Ÿå¾’æ•°ã‚’å¾©å…ƒ
        if (data.studentCount) {
          document.getElementById('student-count').value = data.studentCount;
          handleStudentCountChange();

          // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¾©å…ƒ
          setTimeout(() => {
            data.students.forEach((student, index) => {
              const formDiv = document.querySelector(`.student-form[data-index="${index}"]`);
              const studentSelect = formDiv?.querySelector('.student-select');

              if (formDiv && student.id && studentSelect) {
                studentSelect.value = student.id;

                // ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦è¡¨ç¤º
                google.script.run
                  .withSuccessHandler(function(studentData) {
                    displayStudentData(formDiv, studentData);
                    formDiv.querySelector('.student-info').style.display = 'block';

                    // é …ç›®ã”ã¨ã®ä½œæˆ¦ã‚’å¾©å…ƒ
                    if (student.itemStrategies) {
                      student.itemStrategies.forEach(item => {
                        const input = formDiv.querySelector(
                          `.item-strategy-input[data-category="${item.category}"][data-item="${item.item}"]`
                        );
                        if (input) {
                          input.value = item.strategy;
                        }
                      });
                    }
                  })
                  .getStudentData(student.id);
              }
            });
          }, 100);
        }
      } catch (e) {
        console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    // ä½œæˆ¦ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    function collectStrategyData() {
      const count = document.getElementById('student-count')?.value;
      if (!count) return null;

      const students = [];
      document.querySelectorAll('.student-form').forEach((formDiv, index) => {
        const studentId = formDiv.querySelector('.student-select').value;

        // å„é …ç›®ã®ä½œæˆ¦ã‚’åé›†
        const itemStrategies = [];
        formDiv.querySelectorAll('.item-strategy-input').forEach(input => {
          const category = input.getAttribute('data-category');
          const item = input.getAttribute('data-item');
          const strategy = input.value;

          if (strategy && strategy.trim()) {
            itemStrategies.push({
              category: category,
              item: item,
              strategy: strategy.trim()
            });
          }
        });

        students.push({
          id: studentId,
          itemStrategies: itemStrategies
        });
      });

      return {
        studentCount: count,
        students: students,
        date: new Date().toISOString()
      };
    }

    // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
    function saveStrategyToServer() {
      const data = collectStrategyData();
      if (!data || !data.students.every(s => s.id)) {
        alert('ã™ã¹ã¦ã®ç”Ÿå¾’ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }

      const statusDiv = document.getElementById('save-status');
      statusDiv.textContent = 'ä¿å­˜ä¸­...';

      google.script.run
        .withSuccessHandler(function(result) {
          statusDiv.textContent = 'ä¿å­˜ã—ã¾ã—ãŸï¼ä½œæˆ¦è¡¨ç¤ºãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™...';

          // ä½œæˆ¦è¡¨ç¤ºãƒšãƒ¼ã‚¸ã«é·ç§»ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯æ®‹ã—ã¦ãŠãï¼‰
          setTimeout(() => {
            google.script.run
              .withSuccessHandler(updatePage)
              .withFailureHandler(showError)
              .loadPage('Page-StrategyView');
          }, 1000);
        })
        .withFailureHandler(function(error) {
          statusDiv.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error;
        })
        .saveStrategy(data);
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
    function clearLocalStorage() {
      if (confirm('å…¥åŠ›å†…å®¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹?')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // ========================================
    // ã‚¹ãƒ†ãƒƒãƒ—2: ä½œæˆ¦è¡¨ç¤ºãƒ»æŒ¯ã‚Šè¿”ã‚Šæ©Ÿèƒ½
    // ========================================

    // æœ€æ–°ã®ä½œæˆ¦ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    function loadLatestStrategy() {
      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸä½œæˆ¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (!savedData) {
        console.log('ä¿å­˜ã•ã‚ŒãŸä½œæˆ¦ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        const viewArea = document.getElementById('students-view-area');
        if (viewArea) {
          viewArea.innerHTML = '<p style="color: #999;">ä¿å­˜ã•ã‚ŒãŸä½œæˆ¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ä½œæˆ¦å…¥åŠ›ãƒšãƒ¼ã‚¸ã§ä½œæˆ¦ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>';
        }
        return;
      }

      try {
        const data = JSON.parse(savedData);
        displayStrategyView(data);
      } catch (e) {
        console.error('ä½œæˆ¦ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
        showError('ä½œæˆ¦ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ä½œæˆ¦è¡¨ç¤ºãƒšãƒ¼ã‚¸ã‚’æ§‹ç¯‰
    function displayStrategyView(data) {
      const viewArea = document.getElementById('students-view-area');
      if (!viewArea) return;

      if (!data || !data.students || data.students.length === 0) {
        viewArea.innerHTML = '<p style="color: #999;">ä¿å­˜ã•ã‚ŒãŸä½œæˆ¦ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
      }

      const template = document.getElementById('student-view-template');
      viewArea.innerHTML = '';

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      viewArea.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading-spinner" style="margin: 0 auto;"></div><p style="color: #666; margin-top: 20px;">ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p></div>';

      // å„ç”Ÿå¾’ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ï¼ˆæœ€æ–°ã®æŒ¯ã‚Šè¿”ã‚Šã‚’å«ã‚€ï¼‰
      const studentLoadPromises = data.students.map((student, index) => {
        if (!student.id) return Promise.resolve();

        return new Promise((resolve, reject) => {
          google.script.run
            .withSuccessHandler(function(goalData) {
              resolve({ student, goalData });
            })
            .withFailureHandler(function(error) {
              console.error('ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
              resolve({ student, goalData: null });
            })
            .getStudentData(student.id);
        });
      });

      // ã™ã¹ã¦ã®ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—å®Œäº†å¾Œã«è¡¨ç¤º
      Promise.all(studentLoadPromises).then(results => {
        viewArea.innerHTML = '';

        results.forEach(({ student, goalData }) => {
          if (!student || !student.id) return;

          const clone = template.content.cloneNode(true);
          const formDiv = clone.querySelector('.student-form');
          formDiv.setAttribute('data-student-id', student.id);

          // ç”Ÿå¾’åã‚’è¡¨ç¤º
          const studentInfo = studentsListCache.find(s => s.id === student.id);
          clone.querySelector('.student-name-display').textContent =
            studentInfo ? studentInfo.name : `ç”Ÿå¾’ID: ${student.id}`;

          // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸæœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºï¼ˆæŒ¯ã‚Šè¿”ã‚Šã‚’å«ã‚€ï¼‰
          if (goalData && goalData.goals) {
            displayStrategyViewData(formDiv, goalData, student.itemStrategies || []);
          }

          viewArea.appendChild(clone);

          // Lucideã‚¢ã‚¤ã‚³ãƒ³ã‚’åˆæœŸåŒ–
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
        });

        const saveBtn = document.getElementById('save-feedback-btn');
        if (saveBtn) {
          saveBtn.disabled = false;
        }
      }).catch(error => {
        console.error('ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        viewArea.innerHTML = '<p style="color: #ef4444;">ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      });
    }

    // ä½œæˆ¦è¡¨ç¤ºãƒšãƒ¼ã‚¸ç”¨ã®ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºï¼ˆç›®æ¨™ã¨ä½œæˆ¦ã‚’å„é …ç›®ã”ã¨ã«è¡¨ç¤ºï¼‰
    function displayStrategyViewData(formDiv, goalData, savedStrategies) {
      const goalsFeedbackContainer = formDiv.querySelector('.student-goals-feedback-container');

      // ä½œæˆ¦ã‚’ãƒãƒƒãƒ—åŒ–ï¼ˆé«˜é€Ÿæ¤œç´¢ç”¨ï¼‰
      const strategyMap = {};
      if (savedStrategies && savedStrategies.length > 0) {
        savedStrategies.forEach(item => {
          const key = `${item.category}|||${item.item}`;
          strategyMap[key] = item.strategy;
        });
      }

      // ç›®æ¨™ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
      if (!goalData.goals || goalData.goals.length === 0) {
        goalsFeedbackContainer.innerHTML = '';
        return;
      }

      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
      const categorizedGoals = {};
      goalData.goals.forEach(item => {
        if (!categorizedGoals[item.category]) {
          categorizedGoals[item.category] = [];
        }
        categorizedGoals[item.category].push(item);
      });

      // HTMLã‚’æ§‹ç¯‰ï¼ˆå„é …ç›®ã”ã¨ã«ç›®æ¨™ãƒ»ä½œæˆ¦ãƒ»æŒ¯ã‚Šè¿”ã‚Šå…¥åŠ›ã‚’è¡¨ç¤ºï¼‰
      let html = '';
      for (const category in categorizedGoals) {
        html += `
          <div class="goal-category">
            <h4 class="category-title">${category}</h4>
        `;

        categorizedGoals[category].forEach(item => {
          const hasGoal = item.goal && item.goal.trim();
          const key = `${category}|||${item.item}`;
          const strategy = strategyMap[key] || item.strategy || '';
          const hasStrategy = strategy.trim() !== '';
          const savedFeedback = item.feedback || '';

          html += `
            <div class="goal-item">
              <div class="goal-item-header">
                <strong>${item.item}</strong>
              </div>
              <div class="goal-item-content">
                ${hasGoal ? `<p><span class="label">ç›®æ¨™:</span> ${item.goal}</p>` : '<p class="no-goal">ç›®æ¨™æœªè¨­å®š</p>'}
                ${hasStrategy ? `<p><span class="label">ä½œæˆ¦:</span> <span class="strategy-content readonly">${strategy}</span></p>` : '<p style="color: #999;">ä½œæˆ¦æœªè¨­å®š</p>'}
                <div class="form-group" style="margin-top: 10px;">
                  <label>ã“ã®é …ç›®ã®æŒ¯ã‚Šè¿”ã‚Š:</label>
                  <textarea
                    class="goal-item-feedback-input"
                    data-category="${category}"
                    data-item="${item.item}"
                    rows="3"
                    placeholder="ã“ã®ç›®æ¨™é …ç›®ã«ã¤ã„ã¦ã®æŒ¯ã‚Šè¿”ã‚Šã‚’å…¥åŠ›..."
                  >${savedFeedback}</textarea>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      // çµ±åˆè¡¨ç¤ºï¼ˆä½œæˆ¦ã‚³ãƒ³ãƒ†ãƒŠã¯éè¡¨ç¤ºã«ã—ã¦ã€ç›®æ¨™ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚³ãƒ³ãƒ†ãƒŠã«å…¨ã¦è¡¨ç¤ºï¼‰
      goalsFeedbackContainer.innerHTML = html;
    }

    /**
     * ç”Ÿå¾’1äººåˆ†ã®æŒ¯ã‚Šè¿”ã‚Šã‚’ä¿å­˜ã—ã¦AIç”Ÿæˆ
     */
    function saveSingleStudentFeedback(button) {
      const formDiv = button.closest('.student-form');
      const studentId = formDiv.getAttribute('data-student-id');
      const statusDiv = formDiv.querySelector('.single-student-status');
      const slideSettingsSection = formDiv.querySelector('.slide-settings-section');

      if (!studentId) {
        alert('ç”Ÿå¾’IDãŒå–å¾—ã§ãã¾ã›ã‚“');
        return;
      }

      // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const lessonContentInput = formDiv.querySelector('.lesson-content-input');
      const lessonFeedbackInput = formDiv.querySelector('.lesson-feedback-input');
      const lessonNextInput = formDiv.querySelector('.lesson-next-input');
      const studentConditionInput = formDiv.querySelector('.student-condition-input');
      const studentGrowthInput = formDiv.querySelector('.student-growth-input');
      const studentInfoInput = formDiv.querySelector('.student-info-input');

      // ç›®æ¨™é …ç›®ã”ã¨ã®æŒ¯ã‚Šè¿”ã‚Šã‚’åé›†
      const goalItemsFeedback = [];
      formDiv.querySelectorAll('.goal-item-feedback-input').forEach(input => {
        const category = input.getAttribute('data-category');
        const item = input.getAttribute('data-item');
        const feedback = input.value.trim();

        if (feedback) {
          goalItemsFeedback.push({
            category: category,
            item: item,
            feedback: feedback
          });
        }
      });

      const studentData = {
        id: studentId,
        lessonContent: lessonContentInput ? lessonContentInput.value.trim() : '',
        lessonFeedback: lessonFeedbackInput ? lessonFeedbackInput.value.trim() : '',
        lessonNext: lessonNextInput ? lessonNextInput.value.trim() : '',
        studentCondition: studentConditionInput ? studentConditionInput.value.trim() : '',
        studentGrowth: studentGrowthInput ? studentGrowthInput.value.trim() : '',
        studentInfo: studentInfoInput ? studentInfoInput.value.trim() : '',
        goalItemsFeedback: goalItemsFeedback
      };

      // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
      if (!studentData.lessonContent && !studentData.lessonFeedback && !studentData.lessonNext) {
        alert('æŒ¯ã‚Šè¿”ã‚Šå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      button.disabled = true;
      statusDiv.innerHTML = '<p style="color: #3498db; display: flex; align-items: center; gap: 8px;"><i data-lucide="loader" style="width: 16px; height: 16px; animation: spin 1s linear infinite;"></i>ä¿å­˜ä¸­...</p>';
      lucide.createIcons();

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ï¼ˆAIç”Ÿæˆã¯ã—ãªã„ï¼‰
      google.script.run
        .withSuccessHandler(function(result) {
          statusDiv.innerHTML = '<p style="color: #10b981; font-weight: 600; display: flex; align-items: center; gap: 8px;"><i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>ä¿å­˜å®Œäº†ï¼</p>';
          lucide.createIcons();
          showToast('æŒ¯ã‚Šè¿”ã‚Šã‚’ä¿å­˜ã—ã¾ã—ãŸ');

          // ä¿å­˜å®Œäº†å¾Œã€ä½œæˆ¦å…¥åŠ›ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
          clearStrategyCache();

          // ã‚¹ãƒ©ã‚¤ãƒ‰è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
          slideSettingsSection.style.display = 'block';

          // ã‚¹ãƒ©ã‚¤ãƒ‰è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
          slideSettingsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

          // studentDataã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«ä¿å­˜
          formDiv.setAttribute('data-saved-student-data', JSON.stringify(studentData));

          button.disabled = false;
        })
        .withFailureHandler(function(error) {
          statusDiv.innerHTML = `<p style="color: #ef4444; display: flex; align-items: center; gap: 8px;"><i data-lucide="alert-circle" style="width: 16px; height: 16px;"></i>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
          lucide.createIcons();
          button.disabled = false;
        })
        .saveSingleStudentFeedback(studentData);
    }

    /**
     * ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆï¼ˆè¨­å®šã‚’å«ã‚€ï¼‰
     */
    function generateSlideData(button) {
      const formDiv = button.closest('.student-form');
      const statusDiv = formDiv.querySelector('.single-student-status');
      const slideSettingsSection = formDiv.querySelector('.slide-settings-section');
      const aiPreviewArea = formDiv.querySelector('.ai-preview-area');
      const slideStructurePreview = formDiv.querySelector('.slide-structure-preview');
      const slideGenerateArea = formDiv.querySelector('.slide-generate-area');
      const generateBtn = slideGenerateArea.querySelector('.generate-single-slide-btn');

      // ä¿å­˜ã•ã‚ŒãŸstudentDataã‚’å–å¾—
      const studentDataStr = formDiv.getAttribute('data-saved-student-data');
      if (!studentDataStr) {
        alert('å…ˆã«æŒ¯ã‚Šè¿”ã‚Šã‚’ä¿å­˜ã—ã¦ãã ã•ã„');
        return;
      }
      const studentData = JSON.parse(studentDataStr);

      // è¨­å®šå€¤ã‚’å–å¾—
      const lessonTheme = slideSettingsSection.querySelector('.lesson-theme-input').value.trim();
      const lessonDescription = slideSettingsSection.querySelector('.lesson-description-input').value.trim();
      const targetAge = slideSettingsSection.querySelector('.target-age-input').value;
      const lessonDuration = slideSettingsSection.querySelector('.lesson-duration-input').value;
      const slideCount = slideSettingsSection.querySelector('.slide-count-input').value;
      const lessonStyle = slideSettingsSection.querySelector('.lesson-style-input').value;

      // ãƒ†ãƒ¼ãƒã¯å¿…é ˆ
      if (!lessonTheme) {
        alert('ãƒ¬ãƒƒã‚¹ãƒ³ã®ãƒ†ãƒ¼ãƒã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        slideSettingsSection.querySelector('.lesson-theme-input').focus();
        return;
      }

      const settings = {
        lessonTheme: lessonTheme,
        lessonDescription: lessonDescription,
        targetAge: targetAge,
        lessonDuration: lessonDuration,
        slideCount: slideCount,
        lessonStyle: lessonStyle
      };

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      button.disabled = true;
      statusDiv.innerHTML = '<p style="color: #667eea; display: flex; align-items: center; gap: 8px;"><i data-lucide="loader" class="spin-icon" style="width: 16px; height: 16px;"></i>AIã§ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆä¸­...</p>';
      lucide.createIcons();

      // ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†:', result);

          // çµæœã®æ¤œè¨¼
          if (!result || !result.slideContent || !Array.isArray(result.slideContent)) {
            statusDiv.innerHTML = '<p style="color: #ef4444; display: flex; align-items: center; gap: 8px;"><i data-lucide="alert-circle" style="width: 16px; height: 16px;"></i>ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ©ã‚¤ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            lucide.createIcons();
            console.error('Invalid result:', result);
            button.disabled = false;
            return;
          }

          statusDiv.innerHTML = '<p style="color: #10b981; display: flex; align-items: center; gap: 8px; font-weight: 600;"><i data-lucide="check-circle" style="width: 16px; height: 16px;"></i>ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆå®Œäº†ï¼</p>';
          lucide.createIcons();

          // slideContentã‚’ãƒœã‚¿ãƒ³ã«ä¿å­˜
          generateBtn.setAttribute('data-slide-content', JSON.stringify(result.slideContent));
          generateBtn.setAttribute('data-student-data', JSON.stringify(studentData));

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
          let previewHTML = '<div style="font-family: monospace;">';
          result.slideContent.forEach((slide, index) => {
            const slideTitle = slide.title || `ã‚¹ãƒ©ã‚¤ãƒ‰${index + 1}`;
            const slideType = slide.type || 'unknown';

            previewHTML += `<div style="margin-bottom: 12px; padding: 8px; background: white; border-left: 3px solid #667eea; border-radius: 4px;">`;
            previewHTML += `<strong style="color: #667eea;">${index + 1}. [${slideType}]</strong> ${slideTitle}`;

            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®ä¸€éƒ¨ã‚’è¡¨ç¤º
            if (slide.points && Array.isArray(slide.points)) {
              previewHTML += '<div style="margin-left: 20px; margin-top: 4px; color: #6c757d; font-size: 13px;">';
              slide.points.slice(0, 2).forEach(item => {
                previewHTML += `â€¢ ${item}<br>`;
              });
              if (slide.points.length > 2) {
                previewHTML += `... ä»– ${slide.points.length - 2} é …ç›®`;
              }
              previewHTML += '</div>';
            } else if (slide.items && Array.isArray(slide.items)) {
              previewHTML += '<div style="margin-left: 20px; margin-top: 4px; color: #6c757d; font-size: 13px;">';
              const displayItems = slide.items.slice(0, 2);
              displayItems.forEach(item => {
                const itemText = typeof item === 'string' ? item : (item.title || item.label || JSON.stringify(item));
                previewHTML += `â€¢ ${itemText}<br>`;
              });
              if (slide.items.length > 2) {
                previewHTML += `... ä»– ${slide.items.length - 2} é …ç›®`;
              }
              previewHTML += '</div>';
            }

            previewHTML += '</div>';
          });
          previewHTML += '</div>';

          slideStructurePreview.innerHTML = previewHTML;

          // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
          aiPreviewArea.style.display = 'block';
          aiPreviewArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

          // ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
          setTimeout(() => {
            slideGenerateArea.style.display = 'block';
            slideGenerateArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }, 300);

          button.disabled = false;
        })
        .withFailureHandler(function(error) {
          statusDiv.innerHTML = `<p style="color: #ef4444; display: flex; align-items: center; gap: 8px;"><i data-lucide="alert-circle" style="width: 16px; height: 16px;"></i>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
          lucide.createIcons();
          button.disabled = false;
        })
        .generateSlideDataWithSettings(studentData, settings);
    }

    /**
     * AIç”Ÿæˆå†…å®¹ã‚’å†ç”Ÿæˆ
     */
    function regenerateAIContent(button) {
      const formDiv = button.closest('.student-form');
      const statusDiv = formDiv.querySelector('.single-student-status');
      const aiPreviewContent = formDiv.querySelector('.ai-preview-content');
      const slideGenerateArea = formDiv.querySelector('.slide-generate-area');
      const generateBtn = slideGenerateArea.querySelector('.generate-single-slide-btn');

      // ç·¨é›†ã•ã‚ŒãŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ã‚’å–å¾—
      const editedPreview = aiPreviewContent.value;

      if (!editedPreview || !editedPreview.trim()) {
        alert('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ãŒç©ºã§ã™');
        return;
      }

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      button.disabled = true;
      statusDiv.innerHTML = '<p style="color: #3498db;">ğŸ”„ å†ç”Ÿæˆä¸­...</p>';

      // ç·¨é›†ã•ã‚ŒãŸå†…å®¹ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦slideContentã«åæ˜ 
      // ï¼ˆç°¡æ˜“çš„ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒã—ã€ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆæ™‚ã«ä½¿ç”¨ï¼‰
      // å®Ÿéš›ã®slideContentæ§‹é€ ã¯ä¿æŒã—ã¤ã¤ã€ãƒ†ã‚­ã‚¹ãƒˆã®ã¿æ›´æ–°
      const studentDataStr = generateBtn.getAttribute('data-student-data');

      if (studentDataStr) {
        const studentData = JSON.parse(studentDataStr);

        // ç·¨é›†å†…å®¹ã‚’å†åº¦Geminiã«æŠ•ã’ã¦JSONåŒ–
        google.script.run
          .withSuccessHandler(function(result) {
            console.log('AIå†ç”Ÿæˆå®Œäº†ã€‚çµæœ:', result);

            // çµæœã®æ¤œè¨¼
            if (!result || !result.slideContent || !Array.isArray(result.slideContent)) {
              statusDiv.innerHTML = '<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ã‚¹ãƒ©ã‚¤ãƒ‰ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
              console.error('Invalid result:', result);
              button.disabled = false;
              return;
            }

            statusDiv.innerHTML = '<p style="color: green;">âœ“ å†ç”Ÿæˆå®Œäº†ï¼</p>';
            showToast('AIå†…å®¹ã‚’å†ç”Ÿæˆã—ã¾ã—ãŸ');

            // æ–°ã—ã„slideContentã‚’ãƒœã‚¿ãƒ³ã«ä¿å­˜
            generateBtn.setAttribute('data-slide-content', JSON.stringify(result.slideContent));

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°ï¼ˆè¦‹ã‚„ã™ãã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆï¼‰
            // slideContentã¯é…åˆ—å½¢å¼
            let previewText = `ã€ãƒ¬ãƒƒã‚¹ãƒ³å ±å‘Šã‚¹ãƒ©ã‚¤ãƒ‰ã€‘\n\n`;

            result.slideContent.forEach((slide, index) => {
              // ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã‚’å·¦ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
              const slideTitle = slide.title || `ã‚¹ãƒ©ã‚¤ãƒ‰${index + 1}`;
              previewText += `  ${index + 1}. [${slide.type}] ${slideTitle}\n`;

              // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´ã«å·¦ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
              if (slide.points && Array.isArray(slide.points)) {
                slide.points.forEach(item => {
                  previewText += `     â€¢ ${item}\n`;
                });
              } else if (slide.items && Array.isArray(slide.items)) {
                slide.items.forEach(item => {
                  const itemText = typeof item === 'string' ? item : (item.title || item.label || JSON.stringify(item));
                  previewText += `     â€¢ ${itemText}\n`;
                });
              } else if (slide.steps && Array.isArray(slide.steps)) {
                slide.steps.forEach((step, i) => {
                  previewText += `     ${i + 1}. ${step}\n`;
                });
              }
              previewText += '\n';
            });

            aiPreviewContent.value = previewText;
            button.disabled = false;
          })
          .withFailureHandler(function(error) {
            statusDiv.innerHTML = `<p style="color: red;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
            button.disabled = false;
          })
          .saveSingleStudentFeedback(studentData);
      } else {
        statusDiv.innerHTML = '<p style="color: red;">ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>';
        button.disabled = false;
      }
    }

    /**
     * ç”Ÿå¾’1äººåˆ†ã®ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆ
     */
    function generateSingleStudentSlide(button) {
      const formDiv = button.closest('.student-form');
      const statusDiv = formDiv.querySelector('.single-student-status');

      // ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      const slideContentStr = button.getAttribute('data-slide-content');
      const studentDataStr = button.getAttribute('data-student-data');

      if (!slideContentStr || !studentDataStr) {
        alert('ã‚¹ãƒ©ã‚¤ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚å…ˆã«æŒ¯ã‚Šè¿”ã‚Šã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const slideContent = JSON.parse(slideContentStr);
      const studentData = JSON.parse(studentDataStr);

      // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      button.disabled = true;
      statusDiv.innerHTML = '<p style="color: #f5576c; display: flex; align-items: center; gap: 8px;"><i data-lucide="loader" class="spin-icon" style="width: 18px; height: 18px;"></i>Googleã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ä½œæˆä¸­...</p>';
      lucide.createIcons();

      google.script.run
        .withSuccessHandler(function(result) {
          statusDiv.innerHTML = `
            <div style="padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white;">
              <p style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-weight: 600; font-size: 16px;">
                <i data-lucide="check-circle" style="width: 20px; height: 20px;"></i>
                ã‚¹ãƒ©ã‚¤ãƒ‰ç”Ÿæˆå®Œäº†ï¼
              </p>
              <a href="${result.slideUrl}" target="_blank"
                 style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: white; color: #f5576c; border-radius: 8px; font-weight: 700; text-decoration: none; transition: transform 0.2s;"
                 onmouseover="this.style.transform='scale(1.05)'"
                 onmouseout="this.style.transform='scale(1)'">
                <i data-lucide="external-link" style="width: 18px; height: 18px;"></i>
                ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’é–‹ã
              </a>
            </div>
          `;
          lucide.createIcons();
          showToast('ã‚¹ãƒ©ã‚¤ãƒ‰ã‚’ç”Ÿæˆã—ã¾ã—ãŸï¼');
          setTimeout(() => {
            button.disabled = false;
          }, 2000);
        })
        .withFailureHandler(function(error) {
          statusDiv.innerHTML = `<p style="color: #ef4444; display: flex; align-items: center; gap: 8px;"><i data-lucide="alert-circle" style="width: 18px; height: 18px;"></i>ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
          lucide.createIcons();
          button.disabled = false;
        })
        .generateSingleStudentSlide(slideContent, studentData);
    }

    // ========================================
    // ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»åˆæœŸåŒ–
    // ========================================

    // ç”Ÿå¾’ä¸€è¦§ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function loadStudentsList(callback) {
      google.script.run
        .withSuccessHandler(function(response) {
          try {
            // JSONæ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹
            let students = response;
            console.log('å–å¾—ã—ãŸç”Ÿå¾’ä¸€è¦§:', response);

            // æ–‡å­—åˆ—ã¨ã—ã¦è¿”ã£ã¦ããŸå ´åˆã¯ãƒ‘ãƒ¼ã‚¹
            if (typeof response === 'string') {
              // XSRFãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã®é™¤å»
              if (response.startsWith(")]}'\n")) {
                response = response.substring(4);
              }
              students = JSON.parse(response);
            }

            studentsListCache = students;
            console.log('ç”Ÿå¾’ä¸€è¦§ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ ä»¶æ•°:', Array.isArray(studentsListCache) ? studentsListCache.length : 0);

            // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°å®Ÿè¡Œ
            if (callback && typeof callback === 'function') {
              callback();
            }
          } catch (e) {
            console.error('ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼:', e);
            showError('ç”Ÿå¾’ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ç”Ÿå¾’ä¸€è¦§ã®å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          showError('ç”Ÿå¾’ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');

          // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’è§£é™¤
          hideLoadingOnStrategyInput();
        })
        .getStudentsList();
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.onload = function() {
      google.script.run
        .withSuccessHandler(updatePage)
        .withFailureHandler(showError)
        .loadPage('Page-StrategyInput');
    };

    // ========================================
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    // ========================================

    // Toasté€šçŸ¥ã‚’è¡¨ç¤º
    function showToast(message, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
    function showError(message) {
      console.error('ã‚¨ãƒ©ãƒ¼:', message);
      showToast('ã‚¨ãƒ©ãƒ¼: ' + message, 5000);
    }
  </script>
</body>
</html>
