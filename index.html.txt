<!-- index.html (SPA container) -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>レッスン管理システム</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* ========================================
       共通スタイル
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", sans-serif;
      line-height: 1.65;
      color: #1e293b;
      background: #f8fafc;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h2 {
      color: #0f172a;
      margin-bottom: 24px;
      border-bottom: 3px solid #2563eb;
      padding-bottom: 12px;
      font-size: 1.75rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    h3 {
      color: #1e293b;
      margin: 24px 0 12px;
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    h4 {
      color: #475569;
      margin: 12px 0 8px;
      font-size: 1rem;
      font-weight: 600;
    }

    /* フォーム要素 */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #334155;
      font-size: 0.875rem;
      letter-spacing: 0.01em;
    }

    select, input, textarea {
      width: 100%;
      padding: 12px 14px;
      border: 1.5px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s ease;
      background: white;
      color: #1e293b;
    }

    select:hover, input:hover, textarea:hover {
      border-color: #cbd5e1;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    textarea {
      resize: vertical;
      font-family: inherit;
      line-height: 1.6;
    }

    /* ボタン */
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 10px;
      letter-spacing: 0.01em;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:not(:disabled):hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    button:not(:disabled):active {
      transform: translateY(0);
    }

    button:not(.primary-btn) {
      background: #64748b;
      color: white;
    }

    button:not(.primary-btn):hover:not(:disabled) {
      background: #475569;
    }

    .primary-btn {
      background: #2563eb;
      color: white;
    }

    .primary-btn:hover:not(:disabled) {
      background: #1d4ed8;
    }

    .action-buttons {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 2px solid #e2e8f0;
    }

    /* 生徒フォームコンテナ（横並び対応） */
    #students-area,
    #students-view-area {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
    }

    /* 生徒フォーム */
    .student-form {
      background: white;
      padding: 28px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
      border: 1px solid #e2e8f0;
      flex: 1;
      min-width: 380px;
      transition: all 0.2s ease;
    }

    .student-form:hover {
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07), 0 2px 4px rgba(0, 0, 0, 0.05);
      border-color: #cbd5e1;
    }

    /* 生徒が2人以上の場合は2列表示 */
    #students-area:has(.student-form:nth-child(2)) .student-form,
    #students-view-area:has(.student-form:nth-child(2)) .student-form {
      max-width: calc(50% - 12px);
    }

    /* 生徒が1人の場合は横幅いっぱい */
    #students-area:has(.student-form:only-child) .student-form,
    #students-view-area:has(.student-form:only-child) .student-form {
      max-width: 100%;
    }

    .student-info {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #f1f5f9;
    }

    .info-section {
      background: #f8fafc;
      padding: 18px;
      margin: 12px 0;
      border-radius: 8px;
      border-left: 4px solid #2563eb;
    }

    .info-section p {
      margin: 6px 0;
      font-size: 14px;
      color: #475569;
    }

    /* カテゴリ別目標表示 */
    .goal-category {
      margin: 24px 0;
      padding: 20px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1.5px solid #e2e8f0;
    }

    .category-title {
      color: #0f172a;
      margin: 0 0 16px 0;
      padding-bottom: 10px;
      border-bottom: 2px solid #2563eb;
      font-size: 1.1em;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .goal-item {
      background: white;
      margin: 12px 0;
      padding: 16px;
      border-radius: 10px;
      border: 1.5px solid #e2e8f0;
      transition: all 0.2s ease;
    }

    .goal-item:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      border-color: #2563eb;
      transform: translateY(-1px);
    }

    .goal-item-empty {
      opacity: 0.65;
      background: #f8fafc;
    }

    .goal-item-header {
      margin-bottom: 10px;
      color: #1e293b;
      font-weight: 600;
      font-size: 0.95rem;
    }

    .goal-item-content {
      margin: 8px 0;
    }

    .goal-item-content p {
      margin: 8px 0;
      font-size: 13px;
      line-height: 1.6;
      color: #475569;
    }

    .goal-item-content .label {
      display: inline-block;
      font-weight: 600;
      color: #334155;
      min-width: 100px;
    }

    .goal-item-content .no-goal {
      color: #94a3b8;
      font-style: italic;
    }

    .item-strategy-input {
      width: 100%;
      min-height: 60px;
      margin-top: 8px;
    }

    /* 作戦表示（読み取り専用） */
    .strategy-content.readonly {
      background: #fafafa;
      padding: 4px 12px;
      border-radius: 4px;
      white-space: pre-wrap;
      border: 1.5px solid #bfdbfe;
      font-size: 14px;
      line-height: 1.6;
      color: #1e293b;
    }

    .section {
      margin: 12px 0;
    }

    .strategy-container {
      margin-top: 24px;
      border-top: 2px solid #2563eb;
      border-radius: 12px;
    }

    /* 作戦入力ページのメインカード風スタイル
       - ページコンテンツ内のみ適用して他ページに影響しないようにする */
    .page-content .strategy-input-container .strategy-container {
      border: 1.5px solid #e2e8f0;
      border-radius: 16px;
      padding: 32px;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
      min-height: 70vh;
      display: flex;
      flex-direction: column;
    }

    /* 作戦表示カード */
    .strategy-card {
      background: white;
      padding: 24px;
      margin-bottom: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06), 0 1px 2px rgba(0, 0, 0, 0.04);
      border-left: 4px solid #2563eb;
      border: 1.5px solid #e2e8f0;
      border-left: 4px solid #2563eb;
    }

    .section {
      margin: 16px 0;
    }

    /* ステータス表示 */
    #save-status, #generation-status {
      margin-top: 16px;
      padding: 12px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    .date-display {
      background: #f1f5f9;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      font-weight: 600;
      color: #0f172a;
      border: 1.5px solid #e2e8f0;
    }

    /* Toast通知 */
    .toast {
      position: fixed;
      top: -100px;
      right: 24px;
      background: #10b981;
      color: white;
      padding: 16px 28px;
      border-radius: 10px;
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
      z-index: 9999;
      transition: top 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      font-weight: 600;
      font-size: 14px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .toast.show {
      top: 24px;
    }

    /* ローディング表示 */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 320px;
      padding: 48px;
    }

    .loading-spinner {
      border: 4px solid #e2e8f0;
      border-top: 4px solid #2563eb;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      animation: spin 0.8s linear infinite;
      margin-bottom: 24px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .spin-icon {
      animation: spin 0.8s linear infinite;
    }

    .loading-text {
      color: #64748b;
      font-size: 15px;
      font-weight: 500;
      letter-spacing: 0.01em;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
      body {
        padding: 12px;
      }

      .container {
        padding: 16px 20px;
      }

      .student-form {
        padding: 20px;
        max-width: 100%;
        min-width: 100%;
      }

      .strategy-card {
        padding: 20px;
      }

      .page-content .strategy-input-container .strategy-container {
        padding: 24px;
      }

      button {
        width: 100%;
        margin-bottom: 12px;
        margin-right: 0;
      }

      h2 {
        font-size: 1.5rem;
      }

      .goal-category {
        padding: 16px;
      }

      .goal-item {
        padding: 14px;
      }
    }
  </style>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
  <div class="container">
    <header><?!= include('Header') ?></header>
    <main id="app"><!-- 動的コンテンツ --> </main>
  </div>
  <style>
    /* レイアウトコンテナ幅固定 */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 40px;
      box-sizing: border-box;
    }

    /* 挿入されるページ本体の余白は .page-content に付与する */
    .page-content {
      box-sizing: border-box;
    }
  </style>
  <script>
    // ========================================
    // グローバル変数
    // ========================================
    let studentsListCache = []; // 生徒一覧キャッシュ
    let studentGoalsCache = {}; // 生徒ごとの目標データキャッシュ { studentId: { goals: [...] } }
    const STORAGE_KEY = 'lesson_strategy_draft';

    // ========================================
    // 初期化
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      restoreStrategy();
    });

    // ========================================
    // ページ遷移処理
    // ========================================
    function handleNavClick(event) {
      event.preventDefault();
      const pageName = event.target.getAttribute('data-page');
      if (!pageName) return;

      google.script.run
        .withSuccessHandler(updatePage)
        .withFailureHandler(showError)
        .loadPage(pageName);
    }

    function updatePage(html) {
      // 挿入ページに共通の余白を与えるため、.page-content でラップして挿入
      document.getElementById('app').innerHTML = `<div class="page-content">${html}</div>`;

      // ページ遷移時に一番上にスクロール
      window.scrollTo(0, 0);

      // ページ固有の初期化
      if (html.includes('strategy-input-container')) {
        // 作戦入力ページ: 生徒一覧を取得してからコンテンツを表示
        showLoadingOnStrategyInput();
        loadStudentsList(function() {
          // 生徒一覧の取得が完了したらローディングを解除してコンテンツを表示
          hideLoadingOnStrategyInput();
          restoreStrategy();
        });
      } else if (html.includes('strategy-view-container')) {
        // 作戦表示ページ: キャッシュから作戦データを表示
        loadLatestStrategy();
      }
    }

    // ========================================
    // ステップ1: 作戦入力機能
    // ========================================

    // 作戦入力ページにローディング表示を追加
    function showLoadingOnStrategyInput() {
      const strategyContainer = document.querySelector('.strategy-input-container .strategy-container');
      if (!strategyContainer) return;

      // コンテンツを非表示にしてローディングを表示
      strategyContainer.style.display = 'none';

      // ローディングコンテナを作成
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-container';
      loadingDiv.id = 'students-loading';
      loadingDiv.innerHTML = `
        <div class="loading-spinner"></div>
        <div class="loading-text">生徒一覧を読み込んでいます...</div>
      `;

      // strategy-containerの直前に挿入
      strategyContainer.parentNode.insertBefore(loadingDiv, strategyContainer);
    }

    // ローディングを非表示にしてコンテンツを表示
    function hideLoadingOnStrategyInput() {
      const loadingDiv = document.getElementById('students-loading');
      if (loadingDiv) {
        loadingDiv.remove();
      }

      const strategyContainer = document.querySelector('.strategy-input-container .strategy-container');
      if (strategyContainer) {
        strategyContainer.style.display = 'flex';
      }
    }

    // 生徒数変更時の処理
    function handleStudentCountChange() {
      const count = parseInt(document.getElementById('student-count').value);
      const container = document.getElementById('students-area');
      const template = document.getElementById('student-form-template');

      if (!count || count < 1 || count > 5) {
        container.innerHTML = '';
        document.getElementById('save-strategy-btn').disabled = true;
        return;
      }

      container.innerHTML = '';

      for (let i = 0; i < count; i++) {
        const clone = template.content.cloneNode(true);
        const formDiv = clone.querySelector('.student-form');
        formDiv.setAttribute('data-index', i);
        clone.querySelector('.student-number').textContent = i + 1;

        // 生徒選択ドロップダウンに選択肢を追加
        const select = clone.querySelector('.student-select');
        studentsListCache.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = student.name;
          select.appendChild(option);
        });

        container.appendChild(clone);
      }

      document.getElementById('save-strategy-btn').disabled = false;
    }

    // 生徒選択時にデータ取得
    function loadStudentData(selectElement) {
      const studentId = selectElement.value;
      if (!studentId) return;

      const formDiv = selectElement.closest('.student-form');
      const infoDiv = formDiv.querySelector('.student-info');
      const goalsContainer = formDiv.querySelector('.student-goals-container');

      // キャッシュがあればそれを使用
      if (studentGoalsCache[studentId]) {
        displayStudentData(formDiv, studentGoalsCache[studentId]);
        infoDiv.style.display = 'block';
        return;
      }

      // ローディング表示
      infoDiv.style.display = 'block';
      goalsContainer.innerHTML = `
        <div style="display: flex; flex-direction: column; align-items: center; padding: 40px 20px;">
          <div class="loading-spinner" style="width: 40px; height: 40px; border-width: 3px; margin-bottom: 16px;"></div>
          <div class="loading-text">生徒データを読み込んでいます...</div>
        </div>
      `;

      // キャッシュがなければサーバーから取得
      google.script.run
        .withSuccessHandler(function(data) {
          // キャッシュに保存
          studentGoalsCache[studentId] = data;
          displayStudentData(formDiv, data);
          infoDiv.style.display = 'block';
        })
        .withFailureHandler(function(error) {
          const friendlyMessage = getFriendlyErrorMessage(error);
          showToast(`生徒データの取得に失敗しました: ${friendlyMessage}`, 5000);
          console.error('生徒データ取得エラー:', error);
          // エラー時はローディングを削除
          goalsContainer.innerHTML = '<p style="color: #ef4444;">データの読み込みに失敗しました</p>';
        })
        .getStudentData(studentId);
    }

    // 生徒データを表示（カテゴリ別の目標構造に対応）
    function displayStudentData(formDiv, data) {
      const goalsContainer = formDiv.querySelector('.student-goals-container');

      if (!data.goals || data.goals.length === 0) {
        goalsContainer.innerHTML = '<p style="color: #999;">目標データがありません</p>';
        return;
      }

      // カテゴリごとにグループ化
      const categorized = {};
      data.goals.forEach(item => {
        if (!categorized[item.category]) {
          categorized[item.category] = [];
        }
        categorized[item.category].push(item);
      });

      // HTMLを構築
      let html = '';
      for (const category in categorized) {
        html += `
          <div class="goal-category">
            <h4 class="category-title">${category}</h4>
        `;

        categorized[category].forEach(item => {
          const hasGoal = item.goal && item.goal.trim();
          const itemClass = hasGoal ? 'goal-item' : 'goal-item goal-item-empty';

          html += `
            <div class="${itemClass}">
              <div class="goal-item-header">
                <strong>${item.item}</strong>
              </div>
              <div class="goal-item-content">
                ${hasGoal ? `<p><span class="label">目標:</span> ${item.goal}</p>` : '<p class="no-goal">目標未設定</p>'}
                ${item.lastStrategy ? `<p><span class="label">前回の作戦:</span> ${item.lastStrategy}</p>` : ''}
                ${item.lastResult ? `<p><span class="label">前回の結果:</span> ${item.lastResult}</p>` : ''}
                <div class="form-group">
                  <label>今日の作戦:</label>
                  <textarea
                    class="item-strategy-input"
                    data-category="${category}"
                    data-item="${item.item}"
                    rows="2"
                    placeholder="この項目に関する作戦を入力..."
                    oninput="autoSaveStrategy()"
                  ></textarea>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      goalsContainer.innerHTML = html;
    }

    // ローカルストレージに自動保存
    function autoSaveStrategy() {
      const data = collectStrategyData();
      if (data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }
    }

    // ローカルストレージをクリア
    function clearStrategyCache() {
      localStorage.removeItem(STORAGE_KEY);
      console.log('作戦キャッシュをクリアしました');
    }

    // ローカルストレージから復元
    function restoreStrategy() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return;

      try {
        const data = JSON.parse(saved);
        // 生徒数を復元
        const studentCountElement = document.getElementById('student-count');
        if (data.studentCount && studentCountElement) {
          studentCountElement.value = data.studentCount;
          handleStudentCountChange();

          // 少し待ってから各フィールドを復元
          setTimeout(() => {
            data.students.forEach((student, index) => {
              const formDiv = document.querySelector(`.student-form[data-index="${index}"]`);
              const studentSelect = formDiv?.querySelector('.student-select');

              if (formDiv && student.id && studentSelect) {
                studentSelect.value = student.id;

                // データを再取得して表示
                google.script.run
                  .withSuccessHandler(function(studentData) {
                    displayStudentData(formDiv, studentData);
                    formDiv.querySelector('.student-info').style.display = 'block';

                    // 項目ごとの作戦を復元
                    if (student.itemStrategies) {
                      student.itemStrategies.forEach(item => {
                        const input = formDiv.querySelector(
                          `.item-strategy-input[data-category="${item.category}"][data-item="${item.item}"]`
                        );
                        if (input) {
                          input.value = item.strategy;
                        }
                      });
                    }
                  })
                  .getStudentData(student.id);
              }
            });
          }, 100);
        }
      } catch (e) {
        console.error('復元エラー:', e);
      }
    }

    // 作戦データを収集
    function collectStrategyData() {
      const count = document.getElementById('student-count')?.value;
      if (!count) return null;

      const students = [];
      document.querySelectorAll('.student-form').forEach((formDiv, index) => {
        const studentId = formDiv.querySelector('.student-select').value;

        // 各項目の作戦を収集
        const itemStrategies = [];
        formDiv.querySelectorAll('.item-strategy-input').forEach(input => {
          const category = input.getAttribute('data-category');
          const item = input.getAttribute('data-item');
          const strategy = input.value;

          if (strategy && strategy.trim()) {
            itemStrategies.push({
              category: category,
              item: item,
              strategy: strategy.trim()
            });
          }
        });

        students.push({
          id: studentId,
          itemStrategies: itemStrategies
        });
      });

      return {
        studentCount: count,
        students: students,
        date: new Date().toISOString()
      };
    }

    // サーバーに保存
    function saveStrategyToServer() {
      const data = collectStrategyData();
      if (!data || !data.students.every(s => s.id)) {
        alert('すべての生徒を選択してください');
        return;
      }

      // すぐに作戦表示ページに遷移
      google.script.run
        .withSuccessHandler(updatePage)
        .withFailureHandler(showError)
        .loadPage('Page-StrategyView');

      // バックグラウンドでスプレッドシートに保存
      google.script.run
        .withSuccessHandler(function(result) {
          showToast('スプレッドシートに保存されました');
        })
        .withFailureHandler(function(error) {
          const friendlyMessage = getFriendlyErrorMessage(error);
          showToast(`スプレッドシートへの保存に失敗しました: ${friendlyMessage}`, 5000);
        })
        .saveStrategy(data);
    }

    // ローカルストレージをクリア
    function clearLocalStorage() {
      if (confirm('入力内容をクリアしますか?')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // ========================================
    // ステップ2: 作戦表示・振り返り機能
    // ========================================

    // 最新の作戦を取得して表示
    function loadLatestStrategy() {
      // ローカルストレージから保存された作戦データを取得
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (!savedData) {
        console.log('保存された作戦データがありません');
        const viewArea = document.getElementById('students-view-area');
        if (viewArea) {
          viewArea.innerHTML = '<p style="color: #999;">保存された作戦がありません。先に作戦入力ページで作戦を入力してください。</p>';
        }
        return;
      }

      try {
        const data = JSON.parse(savedData);
        displayStrategyView(data);
      } catch (e) {
        console.error('作戦データのパースエラー:', e);
        showError('作戦データの読み込みに失敗しました');
      }
    }

    // 作戦表示ページを構築
    function displayStrategyView(data) {
      const viewArea = document.getElementById('students-view-area');
      if (!viewArea) return;

      if (!data || !data.students || data.students.length === 0) {
        viewArea.innerHTML = '<p style="color: #999;">保存された作戦がありません。</p>';
        return;
      }

      const template = document.getElementById('student-view-template');
      viewArea.innerHTML = '';

      // 各生徒のデータをキャッシュから取得して表示
      data.students.forEach((student, index) => {
        if (!student || !student.id) return;

        const clone = template.content.cloneNode(true);
        const formDiv = clone.querySelector('.student-form');
        formDiv.setAttribute('data-student-id', student.id);

        // 生徒名を表示
        const studentInfo = studentsListCache.find(s => s.id === student.id);
        clone.querySelector('.student-name-display').textContent =
          studentInfo ? studentInfo.name : `生徒ID: ${student.id}`;

        // キャッシュから目標データを取得して表示
        const goalData = studentGoalsCache[student.id];
        if (goalData && goalData.goals) {
          displayStrategyViewData(formDiv, goalData, student.itemStrategies || []);
        } else {
          // キャッシュにない場合は作戦のみ表示
          const goalsFeedbackContainer = formDiv.querySelector('.student-goals-feedback-container');
          if (goalsFeedbackContainer && student.itemStrategies && student.itemStrategies.length > 0) {
            let html = '<div class="goal-category"><h4 class="category-title">今日の作戦</h4>';
            student.itemStrategies.forEach(item => {
              html += `
                <div class="goal-item">
                  <div class="goal-item-header">
                    <strong>${item.item}</strong>
                  </div>
                  <div class="goal-item-content">
                    <p><span class="label">作戦:</span> <span class="strategy-content readonly">${item.strategy}</span></p>
                  </div>
                </div>
              `;
            });
            html += '</div>';
            goalsFeedbackContainer.innerHTML = html;
          }
        }

        viewArea.appendChild(clone);

        // Lucideアイコンを初期化
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      });

      const saveBtn = document.getElementById('save-feedback-btn');
      if (saveBtn) {
        saveBtn.disabled = false;
      }
    }

    // 作戦表示ページ用のデータ表示（目標と作戦を各項目ごとに表示）
    function displayStrategyViewData(formDiv, goalData, savedStrategies) {
      const goalsFeedbackContainer = formDiv.querySelector('.student-goals-feedback-container');

      // 作戦をマップ化（高速検索用）
      const strategyMap = {};
      if (savedStrategies && savedStrategies.length > 0) {
        savedStrategies.forEach(item => {
          const key = `${item.category}|||${item.item}`;
          strategyMap[key] = item.strategy;
        });
      }

      // 目標データがない場合
      if (!goalData.goals || goalData.goals.length === 0) {
        goalsFeedbackContainer.innerHTML = '';
        return;
      }

      // カテゴリごとにグループ化
      const categorizedGoals = {};
      goalData.goals.forEach(item => {
        if (!categorizedGoals[item.category]) {
          categorizedGoals[item.category] = [];
        }
        categorizedGoals[item.category].push(item);
      });

      // HTMLを構築（各項目ごとに目標・作戦・振り返り入力を表示）
      let html = '';
      for (const category in categorizedGoals) {
        html += `
          <div class="goal-category">
            <h4 class="category-title">${category}</h4>
        `;

        categorizedGoals[category].forEach(item => {
          const hasGoal = item.goal && item.goal.trim();
          const key = `${category}|||${item.item}`;
          const strategy = strategyMap[key] || item.strategy || '';
          const hasStrategy = strategy.trim() !== '';
          const savedFeedback = item.feedback || '';

          html += `
            <div class="goal-item">
              <div class="goal-item-header">
                <strong>${item.item}</strong>
              </div>
              <div class="goal-item-content">
                ${hasGoal ? `<p><span class="label">目標:</span> ${item.goal}</p>` : '<p class="no-goal">目標未設定</p>'}
                ${hasStrategy ? `<p><span class="label">作戦:</span> <span class="strategy-content readonly">${strategy}</span></p>` : '<p style="color: #999;">作戦未設定</p>'}
                <div class="form-group" style="margin-top: 10px;">
                  <label>この項目の振り返り:</label>
                  <textarea
                    class="goal-item-feedback-input"
                    data-category="${category}"
                    data-item="${item.item}"
                    rows="3"
                    placeholder="この目標項目についての振り返りを入力..."
                  >${savedFeedback}</textarea>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      // 統合表示（作戦コンテナは非表示にして、目標フィードバックコンテナに全て表示）
      goalsFeedbackContainer.innerHTML = html;
    }

    /**
     * 生徒1人分の振り返りを保存してAI生成
     */
    function saveSingleStudentFeedback(button) {
      const formDiv = button.closest('.student-form');
      const studentId = formDiv.getAttribute('data-student-id');
      const statusDiv = formDiv.querySelector('.single-student-status');
      const slideSettingsSection = formDiv.querySelector('.slide-settings-section');

      if (!studentId) {
        alert('生徒IDが取得できません');
        return;
      }

      // フォームデータを取得
      const lessonContentInput = formDiv.querySelector('.lesson-content-input');
      const lessonFeedbackInput = formDiv.querySelector('.lesson-feedback-input');
      const lessonNextInput = formDiv.querySelector('.lesson-next-input');
      const studentConditionInput = formDiv.querySelector('.student-condition-input');
      const studentGrowthInput = formDiv.querySelector('.student-growth-input');
      const studentInfoInput = formDiv.querySelector('.student-info-input');

      // 目標項目ごとの振り返りを収集
      const goalItemsFeedback = [];
      formDiv.querySelectorAll('.goal-item-feedback-input').forEach(input => {
        const category = input.getAttribute('data-category');
        const item = input.getAttribute('data-item');
        const feedback = input.value.trim();

        if (feedback) {
          goalItemsFeedback.push({
            category: category,
            item: item,
            feedback: feedback
          });
        }
      });

      const studentData = {
        id: studentId,
        lessonContent: lessonContentInput ? lessonContentInput.value.trim() : '',
        lessonFeedback: lessonFeedbackInput ? lessonFeedbackInput.value.trim() : '',
        lessonNext: lessonNextInput ? lessonNextInput.value.trim() : '',
        studentCondition: studentConditionInput ? studentConditionInput.value.trim() : '',
        studentGrowth: studentGrowthInput ? studentGrowthInput.value.trim() : '',
        studentInfo: studentInfoInput ? studentInfoInput.value.trim() : '',
        goalItemsFeedback: goalItemsFeedback
      };

      // 入力チェック
      if (!studentData.lessonContent && !studentData.lessonFeedback && !studentData.lessonNext) {
        alert('振り返り内容を入力してください');
        return;
      }

      // すぐにstudentDataをフォームに保存
      formDiv.setAttribute('data-saved-student-data', JSON.stringify(studentData));

      // 作戦入力のキャッシュをクリア
      clearStrategyCache();

      // スライド設定セクションを即座に表示
      slideSettingsSection.style.display = 'block';

      // スライド設定セクションまでスクロール
      slideSettingsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

      // バックグラウンドでスプレッドシートに保存
      google.script.run
        .withSuccessHandler(function(result) {
          showToast('スプレッドシートに保存されました');
        })
        .withFailureHandler(function(error) {
          const friendlyMessage = getFriendlyErrorMessage(error);
          showToast(`スプレッドシートへの保存に失敗しました: ${friendlyMessage}`, 5000);
        })
        .saveSingleStudentFeedback(studentData);
    }

    /**
     * スライドデータを生成（設定を含む）
     */
    function generateSlideData(button) {
      const formDiv = button.closest('.student-form');
      const statusDiv = formDiv.querySelector('.single-student-status');
      const slideSettingsSection = formDiv.querySelector('.slide-settings-section');
      const aiPreviewArea = formDiv.querySelector('.ai-preview-area');
      const slideStructurePreview = formDiv.querySelector('.slide-structure-preview');
      const slideGenerateArea = formDiv.querySelector('.slide-generate-area');
      const generateBtn = slideGenerateArea.querySelector('.generate-single-slide-btn');

      // 保存されたstudentDataを取得
      const studentDataStr = formDiv.getAttribute('data-saved-student-data');
      if (!studentDataStr) {
        alert('先に振り返りを保存してください');
        return;
      }
      const studentData = JSON.parse(studentDataStr);

      // 設定値を取得
      const lessonTheme = slideSettingsSection.querySelector('.lesson-theme-input').value.trim();
      const lessonDescription = slideSettingsSection.querySelector('.lesson-description-input').value.trim();
      const targetAge = slideSettingsSection.querySelector('.target-age-input').value;
      const lessonDuration = slideSettingsSection.querySelector('.lesson-duration-input').value;
      const slideCount = slideSettingsSection.querySelector('.slide-count-input').value;
      const lessonStyle = slideSettingsSection.querySelector('.lesson-style-input').value;

      // テーマは必須
      if (!lessonTheme) {
        alert('レッスンのテーマを入力してください');
        slideSettingsSection.querySelector('.lesson-theme-input').focus();
        return;
      }

      const settings = {
        lessonTheme: lessonTheme,
        lessonDescription: lessonDescription,
        targetAge: targetAge,
        lessonDuration: lessonDuration,
        slideCount: slideCount,
        lessonStyle: lessonStyle
      };

      // ボタンのテキストを変更して無効化
      const originalButtonText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i data-lucide="loader" class="spin-icon" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>AIで生成中...';
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }

      // サーバー側でスライドデータを生成
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('スライドデータ生成完了:', result);

          // 結果の検証
          if (!result || !result.slideContent || !Array.isArray(result.slideContent)) {
            button.innerHTML = originalButtonText;
            button.disabled = false;
            statusDiv.innerHTML = '<p style="color: #ef4444; display: flex; align-items: center; gap: 8px;"><i data-lucide="alert-circle" style="width: 16px; height: 16px;"></i>エラー: スライドコンテンツの生成に失敗しました。もう一度お試しください。</p>';
            if (typeof lucide !== 'undefined') {
              lucide.createIcons();
            }
            console.error('Invalid result:', result);
            return;
          }

          button.innerHTML = '<i data-lucide="check-circle" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>生成完了！';
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          statusDiv.innerHTML = '';

          // slideContentをボタンに保存
          generateBtn.setAttribute('data-slide-content', JSON.stringify(result.slideContent));
          generateBtn.setAttribute('data-student-data', JSON.stringify(studentData));

          // プレビューを生成
          let previewHTML = '<div style="font-family: monospace;">';
          result.slideContent.forEach((slide, index) => {
            const slideTitle = slide.title || `スライド${index + 1}`;
            const slideType = slide.type || 'unknown';

            previewHTML += `<div style="margin-bottom: 12px; padding: 8px; background: white; border-left: 3px solid #667eea; border-radius: 4px;">`;
            previewHTML += `<strong style="color: #667eea;">${index + 1}. [${slideType}]</strong> ${slideTitle}`;

            // コンテンツの一部を表示
            if (slide.points && Array.isArray(slide.points)) {
              previewHTML += '<div style="margin-left: 20px; margin-top: 4px; color: #6c757d; font-size: 13px;">';
              slide.points.slice(0, 2).forEach(item => {
                previewHTML += `• ${item}<br>`;
              });
              if (slide.points.length > 2) {
                previewHTML += `... 他 ${slide.points.length - 2} 項目`;
              }
              previewHTML += '</div>';
            } else if (slide.items && Array.isArray(slide.items)) {
              previewHTML += '<div style="margin-left: 20px; margin-top: 4px; color: #6c757d; font-size: 13px;">';
              const displayItems = slide.items.slice(0, 2);
              displayItems.forEach(item => {
                const itemText = typeof item === 'string' ? item : (item.title || item.label || JSON.stringify(item));
                previewHTML += `• ${itemText}<br>`;
              });
              if (slide.items.length > 2) {
                previewHTML += `... 他 ${slide.items.length - 2} 項目`;
              }
              previewHTML += '</div>';
            }

            previewHTML += '</div>';
          });
          previewHTML += '</div>';

          slideStructurePreview.innerHTML = previewHTML;

          // プレビューエリアを表示
          aiPreviewArea.style.display = 'block';
          aiPreviewArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

          // スライド生成ボタンを表示
          setTimeout(() => {
            slideGenerateArea.style.display = 'block';
            slideGenerateArea.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // 2秒後にボタンを元に戻す
            setTimeout(() => {
              button.innerHTML = originalButtonText;
              button.disabled = false;
            }, 2000);
          }, 300);
        })
        .withFailureHandler(function(error) {
          button.innerHTML = originalButtonText;
          button.disabled = false;
          handleApiError(error, statusDiv, 'スライドデータ生成');
        })
        .generateSlideDataWithSettings(studentData, settings);
    }


    /**
     * 生徒1人分のスライドを生成
     */
    function generateSingleStudentSlide(button) {
      const formDiv = button.closest('.student-form');
      const statusDiv = formDiv.querySelector('.single-student-status');

      // 保存されたデータを取得
      const slideContentStr = button.getAttribute('data-slide-content');
      const studentDataStr = button.getAttribute('data-student-data');

      if (!slideContentStr || !studentDataStr) {
        alert('スライドデータが取得できません。先に振り返りを保存してください。');
        return;
      }

      const slideContent = JSON.parse(slideContentStr);
      const studentData = JSON.parse(studentDataStr);

      // ボタンのテキストを変更して無効化
      const originalButtonText = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i data-lucide="loader" class="spin-icon" style="width: 16px; height: 16px; display: inline-block; vertical-align: middle; margin-right: 6px;"></i>スライド作成中...';
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }

      google.script.run
        .withSuccessHandler(function(result) {
          // 成功時は元のデザインで表示（グラデーション保持）
          statusDiv.innerHTML = `
            <div style="padding: 15px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white;">
              <p style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; font-weight: 600; font-size: 16px;">
                <i data-lucide="check-circle" style="width: 20px; height: 20px;"></i>
                スライド生成完了！
              </p>
              <a href="${result.slideUrl}" target="_blank"
                 style="display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px; background: white; color: #f5576c; border-radius: 8px; font-weight: 700; text-decoration: none; transition: transform 0.2s;"
                 onmouseover="this.style.transform='scale(1.05)'"
                 onmouseout="this.style.transform='scale(1)'">
                <i data-lucide="external-link" style="width: 18px; height: 18px;"></i>
                スライドを開く
              </a>
            </div>
          `;
          if (typeof lucide !== 'undefined') {
            lucide.createIcons();
          }
          showToast('スライドを生成しました！');

          // ボタンを元に戻す
          button.innerHTML = originalButtonText;
          setTimeout(() => {
            button.disabled = false;
          }, 2000);
        })
        .withFailureHandler(function(error) {
          button.innerHTML = originalButtonText;
          button.disabled = false;
          handleApiError(error, statusDiv, 'スライド生成');
        })
        .generateSingleStudentSlide(slideContent, studentData);
    }

    // ========================================
    // データ取得・初期化
    // ========================================

    // 生徒一覧を取得する関数
    function loadStudentsList(callback) {
      google.script.run
        .withSuccessHandler(function(response) {
          try {
            // JSON文字列をパース
            let students = response;
            console.log('取得した生徒一覧:', response);

            // 文字列として返ってきた場合はパース
            if (typeof response === 'string') {
              // XSRFプレフィックスの除去
              if (response.startsWith(")]}'\n")) {
                response = response.substring(4);
              }
              students = JSON.parse(response);
            }

            studentsListCache = students;
            console.log('生徒一覧をキャッシュしました 件数:', Array.isArray(studentsListCache) ? studentsListCache.length : 0);

            // コールバックが指定されていれば実行
            if (callback && typeof callback === 'function') {
              callback();
            }
          } catch (e) {
            console.error('生徒データのパースエラー:', e);
            showError('生徒データの読み込みに失敗しました');
          }
        })
        .withFailureHandler(function(error) {
          const friendlyMessage = getFriendlyErrorMessage(error);
          console.error('生徒一覧の取得エラー:', error);
          showToast(`生徒一覧の取得に失敗しました: ${friendlyMessage}`, 5000);

          // エラー時もローディングを解除
          hideLoadingOnStrategyInput();
        })
        .getStudentsList();
    }

    // ページ読み込み時の初期化
    window.onload = function() {
      google.script.run
        .withSuccessHandler(updatePage)
        .withFailureHandler(showError)
        .loadPage('Page-StrategyInput');
    };

    // ========================================
    // ユーティリティ
    // ========================================

    // Toast通知を表示
    function showToast(message, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // エラー表示
    function showError(message) {
      console.error('エラー:', message);
      showToast('エラー: ' + message, 5000);
    }

    /**
     * エラーメッセージをユーザーフレンドリーに変換
     * 429エラー（Google API制限）を検出して適切なメッセージを返す
     */
    function getFriendlyErrorMessage(error) {
      const errorStr = error.toString ? error.toString() : String(error);
      const errorMessage = error.message || errorStr;

      // 429エラー（Too Many Requests）を検出
      if (errorStr.includes('429') || errorMessage.includes('429') ||
          errorStr.includes('Too Many Requests') || errorMessage.includes('Too Many Requests') ||
          errorStr.includes('Quota exceeded') || errorMessage.includes('Quota exceeded')) {
        return 'Google APIの制限に達しました。もう一度お試しください。';
      }

      // その他のエラー
      return errorMessage;
    }

    /**
     * エラーハンドラー共通処理
     * ステータス表示要素にエラーメッセージを表示
     */
    function handleApiError(error, statusDiv, context = '') {
      const friendlyMessage = getFriendlyErrorMessage(error);
      console.error(`${context}エラー:`, error);

      if (statusDiv) {
        statusDiv.innerHTML = `
          <p style="color: #ef4444; display: flex; align-items: center; gap: 8px;">
            <i data-lucide="alert-circle" style="width: 16px; height: 16px;"></i>
            エラー: ${friendlyMessage}
          </p>
        `;
        if (typeof lucide !== 'undefined') {
          lucide.createIcons();
        }
      } else {
        showToast(`エラー: ${friendlyMessage}`, 5000);
      }
    }
  </script>
</body>
</html>
