<!-- index.html (SPA container) -->
<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>レッスン管理システム</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* ========================================
       共通スタイル
       ======================================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      background: #ffffffff;
    }

    h2 {
      color: #6C757D;
      margin-bottom: 20px;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
    }

    h3 {
      color: #34495e;
      margin: 20px 0 10px;
    }

    h4 {
      color: #7f8c8d;
      margin: 10px 0 5px;
      font-size: 0.9em;
    }

    /* フォーム要素 */
    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 5px;
      color: #555;
    }

    select, input, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    select:focus, input:focus, textarea:focus {
      outline: none;
      border-color: #3498db;
    }

    textarea {
      resize: vertical;
      font-family: inherit;
    }

    /* ボタン */
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 10px;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:not(:disabled):hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    button:not(.primary-btn) {
      background: #95a5a6;
      color: white;
    }

    .primary-btn {
      background: #3498db;
      color: white;
    }

    .action-buttons {
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #ddd;
    }

    /* 生徒フォームコンテナ（横並び対応） */
    #students-area,
    #students-view-area {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }

    /* 生徒フォーム */
    .student-form {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 350px;
    }

    /* 生徒が2人以上の場合は2列表示 */
    #students-area:has(.student-form:nth-child(2)) .student-form,
    #students-view-area:has(.student-form:nth-child(2)) .student-form {
      max-width: calc(50% - 10px);
    }

    /* 生徒が1人の場合は横幅いっぱい */
    #students-area:has(.student-form:only-child) .student-form,
    #students-view-area:has(.student-form:only-child) .student-form {
      max-width: 100%;
    }

    .student-info {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #eee;
    }

    .info-section {
      background: #f9f9f9;
      padding: 15px;
      margin: 10px 0;
      border-radius: 4px;
      border-left: 4px solid #3498db;
    }

    .info-section p {
      margin: 5px 0;
      font-size: 14px;
    }

    /* カテゴリ別目標表示 */
    .goal-category {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .category-title {
      color: #2c3e50;
      margin: 0 0 15px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #3498db;
      font-size: 1.1em;
    }

    .goal-item {
      background: white;
      margin: 10px 0;
      padding: 12px;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
      transition: all 0.2s;
    }

    .goal-item:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-color: #3498db;
    }

    .goal-item-empty {
      opacity: 0.7;
      background: #fafafa;
    }

    .goal-item-header {
      margin-bottom: 8px;
      color: #34495e;
    }

    .goal-item-content p {
      margin: 6px 0;
      font-size: 13px;
      line-height: 1.5;
    }

    .goal-item-content .label {
      display: inline-block;
      font-weight: 600;
      color: #555;
      min-width: 100px;
    }

    .goal-item-content .no-goal {
      color: #999;
      font-style: italic;
    }

    .item-strategy-input {
      width: 100%;
      min-height: 50px;
      margin-top: 5px;
    }

    /* 作戦表示（読み取り専用） */
    .strategy-content.readonly {
      background: #f0f8ff;
      padding: 10px;
      border-radius: 4px;
      white-space: pre-wrap;
      border: 1px solid #d0e7f9;
      font-size: 14px;
      line-height: 1.5;
      margin: 8px 0;
    }

    .section {
      margin: 10px 0;
    }

    .strategy-container {
      margin-top: 20px;
      border-top: 2px solid #3498db;
      border-radius: 8px;
    }

    /* 作戦入力ページのメインカード風スタイル
       - ページコンテンツ内のみ適用して他ページに影響しないようにする */
    .page-content .strategy-input-container .strategy-container {
      border: 1px solid #e0e6ee;
      border-radius: 12px;
      padding: 24px;
      background: #ffffff;
      box-shadow: 0 4px 12px rgba(16,24,40,0.04);
      min-height: 70vh; /* かなり下まで高さを確保 */
      display: flex;
      flex-direction: column;
    }

    /* 作戦表示カード */
    .strategy-card {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      border-left: 5px solid #3498db;
    }

    .strategy-content.readonly {
      background: #f0f8ff;
      padding: 15px;
      border-radius: 4px;
      white-space: pre-wrap;
      font-family: monospace;
      border: 1px solid #d0e7f9;
    }

    .section {
      margin: 15px 0;
    }

    /* ステータス表示 */
    #save-status, #generation-status {
      margin-top: 15px;
      padding: 10px;
      border-radius: 4px;
      font-weight: 600;
    }

    .date-display {
      background: #ecf0f1;
      padding: 10px 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-weight: 600;
      color: #2c3e50;
    }

    /* Toast通知 */
    .toast {
      position: fixed;
      bottom: -100px;
      right: 20px;
      background: #2ecc71;
      color: white;
      padding: 15px 25px;
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 9999;
      transition: bottom 0.3s ease;
      font-weight: 600;
    }

    .toast.show {
      bottom: 20px;
    }

    /* ローディング表示 */
    .loading-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 300px;
      padding: 40px;
    }

    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #666;
      font-size: 16px;
      font-weight: 500;
    }

    /* レスポンシブ */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      .student-form {
        padding: 15px;
        max-width: 100%; /* モバイルでは1列表示 */
        min-width: 100%;
      }

      .strategy-card {
        padding: 15px;
      }

      button {
        width: 100%;
        margin-bottom: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header><?!= include('Header') ?></header>
    <main id="app"><!-- 動的コンテンツ --> </main>
  </div>
  <style>
    /* レイアウトコンテナ幅固定 */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px 40px;
      box-sizing: border-box;
    }

    /* 挿入されるページ本体の余白は .page-content に付与する */
    .page-content {
      box-sizing: border-box;
    }
  </style>
  <script>
    // ========================================
    // グローバル変数
    // ========================================
    let studentsListCache = []; // 生徒一覧キャッシュ
    let studentGoalsCache = {}; // 生徒ごとの目標データキャッシュ { studentId: { goals: [...] } }
    const STORAGE_KEY = 'lesson_strategy_draft';

    // ========================================
    // 初期化
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
      restoreStrategy();
    });

    // ========================================
    // ページ遷移処理
    // ========================================
    function handleNavClick(event) {
      event.preventDefault();
      const pageName = event.target.getAttribute('data-page');
      if (!pageName) return;

      google.script.run
        .withSuccessHandler(updatePage)
        .withFailureHandler(showError)
        .loadPage(pageName);
    }

    function updatePage(html) {
      // 挿入ページに共通の余白を与えるため、.page-content でラップして挿入
      document.getElementById('app').innerHTML = `<div class="page-content">${html}</div>`;

      // ページ遷移時に一番上にスクロール
      window.scrollTo(0, 0);

      // ページ固有の初期化
      if (html.includes('strategy-input-container')) {
        // 作戦入力ページ: 生徒一覧を取得してからコンテンツを表示
        showLoadingOnStrategyInput();
        loadStudentsList(function() {
          // 生徒一覧の取得が完了したらローディングを解除してコンテンツを表示
          hideLoadingOnStrategyInput();
          restoreStrategy();
        });
      } else if (html.includes('strategy-view-container')) {
        // 作戦表示ページ: キャッシュから作戦データを表示
        loadLatestStrategy();
      }
    }

    // ========================================
    // ステップ1: 作戦入力機能
    // ========================================

    // 作戦入力ページにローディング表示を追加
    function showLoadingOnStrategyInput() {
      const strategyContainer = document.querySelector('.strategy-input-container .strategy-container');
      if (!strategyContainer) return;

      // コンテンツを非表示にしてローディングを表示
      strategyContainer.style.display = 'none';

      // ローディングコンテナを作成
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-container';
      loadingDiv.id = 'students-loading';
      loadingDiv.innerHTML = `
        <div class="loading-spinner"></div>
        <div class="loading-text">生徒一覧を読み込んでいます...</div>
      `;

      // strategy-containerの直前に挿入
      strategyContainer.parentNode.insertBefore(loadingDiv, strategyContainer);
    }

    // ローディングを非表示にしてコンテンツを表示
    function hideLoadingOnStrategyInput() {
      const loadingDiv = document.getElementById('students-loading');
      if (loadingDiv) {
        loadingDiv.remove();
      }

      const strategyContainer = document.querySelector('.strategy-input-container .strategy-container');
      if (strategyContainer) {
        strategyContainer.style.display = 'flex';
      }
    }

    // 生徒数変更時の処理
    function handleStudentCountChange() {
      const count = parseInt(document.getElementById('student-count').value);
      const container = document.getElementById('students-area');
      const template = document.getElementById('student-form-template');

      if (!count || count < 1 || count > 5) {
        container.innerHTML = '';
        document.getElementById('save-strategy-btn').disabled = true;
        return;
      }

      container.innerHTML = '';

      for (let i = 0; i < count; i++) {
        const clone = template.content.cloneNode(true);
        const formDiv = clone.querySelector('.student-form');
        formDiv.setAttribute('data-index', i);
        clone.querySelector('.student-number').textContent = i + 1;

        // 生徒選択ドロップダウンに選択肢を追加
        const select = clone.querySelector('.student-select');
        studentsListCache.forEach(student => {
          const option = document.createElement('option');
          option.value = student.id;
          option.textContent = student.name;
          select.appendChild(option);
        });

        container.appendChild(clone);
      }

      document.getElementById('save-strategy-btn').disabled = false;
    }

    // 生徒選択時にデータ取得
    function loadStudentData(selectElement) {
      const studentId = selectElement.value;
      if (!studentId) return;

      const formDiv = selectElement.closest('.student-form');
      const infoDiv = formDiv.querySelector('.student-info');

      // キャッシュがあればそれを使用
      if (studentGoalsCache[studentId]) {
        displayStudentData(formDiv, studentGoalsCache[studentId]);
        infoDiv.style.display = 'block';
        return;
      }

      // キャッシュがなければサーバーから取得
      google.script.run
        .withSuccessHandler(function(data) {
          // キャッシュに保存
          studentGoalsCache[studentId] = data;
          displayStudentData(formDiv, data);
          infoDiv.style.display = 'block';
        })
        .withFailureHandler(showError)
        .getStudentData(studentId);
    }

    // 生徒データを表示（カテゴリ別の目標構造に対応）
    function displayStudentData(formDiv, data) {
      const goalsContainer = formDiv.querySelector('.student-goals-container');

      if (!data.goals || data.goals.length === 0) {
        goalsContainer.innerHTML = '<p style="color: #999;">目標データがありません</p>';
        return;
      }

      // カテゴリごとにグループ化
      const categorized = {};
      data.goals.forEach(item => {
        if (!categorized[item.category]) {
          categorized[item.category] = [];
        }
        categorized[item.category].push(item);
      });

      // HTMLを構築
      let html = '';
      for (const category in categorized) {
        html += `
          <div class="goal-category">
            <h4 class="category-title">${category}</h4>
        `;

        categorized[category].forEach(item => {
          const hasGoal = item.goal && item.goal.trim();
          const itemClass = hasGoal ? 'goal-item' : 'goal-item goal-item-empty';

          html += `
            <div class="${itemClass}">
              <div class="goal-item-header">
                <strong>${item.item}</strong>
              </div>
              <div class="goal-item-content">
                ${hasGoal ? `<p><span class="label">目標:</span> ${item.goal}</p>` : '<p class="no-goal">目標未設定</p>'}
                ${item.lastStrategy ? `<p><span class="label">前回の作戦:</span> ${item.lastStrategy}</p>` : ''}
                ${item.lastResult ? `<p><span class="label">前回の結果:</span> ${item.lastResult}</p>` : ''}
                <div class="form-group">
                  <label>今日の作戦:</label>
                  <textarea
                    class="item-strategy-input"
                    data-category="${category}"
                    data-item="${item.item}"
                    rows="2"
                    placeholder="この項目に関する作戦を入力..."
                    oninput="autoSaveStrategy()"
                  ></textarea>
                </div>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      goalsContainer.innerHTML = html;
    }

    // ローカルストレージに自動保存
    function autoSaveStrategy() {
      const data = collectStrategyData();
      if (data) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      }
    }

    // ローカルストレージから復元
    function restoreStrategy() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (!saved) return;

      try {
        const data = JSON.parse(saved);
        // 生徒数を復元
        if (data.studentCount) {
          document.getElementById('student-count').value = data.studentCount;
          handleStudentCountChange();

          // 少し待ってから各フィールドを復元
          setTimeout(() => {
            data.students.forEach((student, index) => {
              const formDiv = document.querySelector(`.student-form[data-index="${index}"]`);
              if (formDiv && student.id) {
                formDiv.querySelector('.student-select').value = student.id;

                // データを再取得して表示
                google.script.run
                  .withSuccessHandler(function(studentData) {
                    displayStudentData(formDiv, studentData);
                    formDiv.querySelector('.student-info').style.display = 'block';

                    // 項目ごとの作戦を復元
                    if (student.itemStrategies) {
                      student.itemStrategies.forEach(item => {
                        const input = formDiv.querySelector(
                          `.item-strategy-input[data-category="${item.category}"][data-item="${item.item}"]`
                        );
                        if (input) {
                          input.value = item.strategy;
                        }
                      });
                    }
                  })
                  .getStudentData(student.id);
              }
            });
          }, 100);
        }
      } catch (e) {
        console.error('復元エラー:', e);
      }
    }

    // 作戦データを収集
    function collectStrategyData() {
      const count = document.getElementById('student-count')?.value;
      if (!count) return null;

      const students = [];
      document.querySelectorAll('.student-form').forEach((formDiv, index) => {
        const studentId = formDiv.querySelector('.student-select').value;

        // 各項目の作戦を収集
        const itemStrategies = [];
        formDiv.querySelectorAll('.item-strategy-input').forEach(input => {
          const category = input.getAttribute('data-category');
          const item = input.getAttribute('data-item');
          const strategy = input.value;

          if (strategy && strategy.trim()) {
            itemStrategies.push({
              category: category,
              item: item,
              strategy: strategy.trim()
            });
          }
        });

        students.push({
          id: studentId,
          itemStrategies: itemStrategies
        });
      });

      return {
        studentCount: count,
        students: students,
        date: new Date().toISOString()
      };
    }

    // サーバーに保存
    function saveStrategyToServer() {
      const data = collectStrategyData();
      if (!data || !data.students.every(s => s.id)) {
        alert('すべての生徒を選択してください');
        return;
      }

      const statusDiv = document.getElementById('save-status');
      statusDiv.textContent = '保存中...';

      google.script.run
        .withSuccessHandler(function(result) {
          statusDiv.textContent = '保存しました！作戦表示ページに移動します...';

          // 作戦表示ページに遷移（ローカルストレージは残しておく）
          setTimeout(() => {
            google.script.run
              .withSuccessHandler(updatePage)
              .withFailureHandler(showError)
              .loadPage('Page-StrategyView');
          }, 1000);
        })
        .withFailureHandler(function(error) {
          statusDiv.textContent = 'エラー: ' + error;
        })
        .saveStrategy(data);
    }

    // ローカルストレージをクリア
    function clearLocalStorage() {
      if (confirm('入力内容をクリアしますか?')) {
        localStorage.removeItem(STORAGE_KEY);
        location.reload();
      }
    }

    // ========================================
    // ステップ2: 作戦表示・振り返り機能
    // ========================================

    // 最新の作戦を取得して表示
    function loadLatestStrategy() {
      // ローカルストレージから保存された作戦データを取得
      const savedData = localStorage.getItem(STORAGE_KEY);
      if (!savedData) {
        console.log('保存された作戦データがありません');
        const viewArea = document.getElementById('students-view-area');
        if (viewArea) {
          viewArea.innerHTML = '<p style="color: #999;">保存された作戦がありません。先に作戦入力ページで作戦を入力してください。</p>';
        }
        return;
      }

      try {
        const data = JSON.parse(savedData);
        displayStrategyView(data);
      } catch (e) {
        console.error('作戦データのパースエラー:', e);
        showError('作戦データの読み込みに失敗しました');
      }
    }

    // 作戦表示ページを構築
    function displayStrategyView(data) {
      const viewArea = document.getElementById('students-view-area');
      if (!viewArea) return;

      if (!data || !data.students || data.students.length === 0) {
        viewArea.innerHTML = '<p style="color: #999;">保存された作戦がありません。</p>';
        return;
      }

      const template = document.getElementById('student-view-template');
      viewArea.innerHTML = '';

      data.students.forEach((student, index) => {
        if (!student.id) return;

        const clone = template.content.cloneNode(true);
        const formDiv = clone.querySelector('.student-form');
        formDiv.setAttribute('data-student-id', student.id);

        // 生徒名を表示
        const studentInfo = studentsListCache.find(s => s.id === student.id);
        clone.querySelector('.student-name-display').textContent =
          studentInfo ? studentInfo.name : `生徒ID: ${student.id}`;

        // キャッシュから目標データを取得して表示
        if (studentGoalsCache[student.id]) {
          displayStrategyViewData(formDiv, studentGoalsCache[student.id], student.itemStrategies || []);
        }

        viewArea.appendChild(clone);
      });

      const saveBtn = document.getElementById('save-feedback-btn');
      if (saveBtn) {
        saveBtn.disabled = false;
      }
    }

    // 作戦表示ページ用のデータ表示（作戦のみ表示、振り返りは生徒全体）
    function displayStrategyViewData(formDiv, goalData, savedStrategies) {
      const strategiesContainer = formDiv.querySelector('.student-strategies-container');

      if (!savedStrategies || savedStrategies.length === 0) {
        strategiesContainer.innerHTML = '<p style="color: #999;">入力された作戦がありません</p>';
        return;
      }

      // カテゴリごとにグループ化
      const categorized = {};
      savedStrategies.forEach(item => {
        if (!categorized[item.category]) {
          categorized[item.category] = [];
        }
        categorized[item.category].push(item);
      });

      // HTMLを構築（作戦の表示のみ）
      let html = '';
      for (const category in categorized) {
        html += `
          <div class="goal-category">
            <h4 class="category-title">${category}</h4>
        `;

        categorized[category].forEach(item => {
          html += `
            <div class="goal-item">
              <div class="goal-item-header">
                <strong>${item.item}</strong>
              </div>
              <div class="goal-item-content">
                <div class="strategy-content readonly">${item.strategy}</div>
              </div>
            </div>
          `;
        });

        html += '</div>';
      }

      strategiesContainer.innerHTML = html;
    }

    // 振り返りを保存してスライド生成
    function saveFeedbackAndGenerate() {
      const forms = document.querySelectorAll('#students-view-area .student-form');
      if (forms.length === 0) {
        alert('作戦データがありません');
        return;
      }

      const students = [];
      forms.forEach(formDiv => {
        const studentId = formDiv.getAttribute('data-student-id');
        if (!studentId) return;

        // 生徒ごとの全体振り返りを収集
        const lessonContentInput = formDiv.querySelector('.lesson-content-input');
        const lessonFeedbackInput = formDiv.querySelector('.lesson-feedback-input');
        const lessonNextInput = formDiv.querySelector('.lesson-next-input');

        const lessonContent = lessonContentInput ? lessonContentInput.value.trim() : '';
        const lessonFeedback = lessonFeedbackInput ? lessonFeedbackInput.value.trim() : '';
        const lessonNext = lessonNextInput ? lessonNextInput.value.trim() : '';

        // 少なくとも1つは入力されている場合のみ追加
        if (lessonContent || lessonFeedback || lessonNext) {
          students.push({
            id: studentId,
            lessonContent: lessonContent,
            lessonFeedback: lessonFeedback,
            lessonNext: lessonNext
          });
        }
      });

      if (students.length === 0) {
        alert('振り返りデータが入力されていません');
        return;
      }

      const data = {
        date: new Date().toISOString(),
        students: students
      };

      const statusDiv = document.getElementById('generation-status');
      statusDiv.textContent = '保存中...スライドを生成しています...';
      document.getElementById('save-feedback-btn').disabled = true;

      google.script.run
        .withSuccessHandler(function(result) {
          statusDiv.innerHTML = `
            <p style="color: green;">✓ 保存が完了しました！</p>
            <p>スライドURL: <a href="${result.slideUrl}" target="_blank">${result.slideUrl}</a></p>
          `;
          showToast('スライドを生成しました！');
          setTimeout(() => {
            document.getElementById('save-feedback-btn').disabled = false;
          }, 3000);
        })
        .withFailureHandler(function(error) {
          statusDiv.innerHTML = `<p style="color: red;">エラー: ${error.message}</p>`;
          document.getElementById('save-feedback-btn').disabled = false;
        })
        .saveFeedbackAndGenerateSlide(data);
    }

    // ========================================
    // データ取得・初期化
    // ========================================

    // 生徒一覧を取得する関数
    function loadStudentsList(callback) {
      google.script.run
        .withSuccessHandler(function(response) {
          try {
            // JSON文字列をパース
            let students = response;
            console.log('取得した生徒一覧:', response);

            // 文字列として返ってきた場合はパース
            if (typeof response === 'string') {
              // XSRFプレフィックスの除去
              if (response.startsWith(")]}'\n")) {
                response = response.substring(4);
              }
              students = JSON.parse(response);
            }

            studentsListCache = students;
            console.log('生徒一覧をキャッシュしました 件数:', Array.isArray(studentsListCache) ? studentsListCache.length : 0);

            // コールバックが指定されていれば実行
            if (callback && typeof callback === 'function') {
              callback();
            }
          } catch (e) {
            console.error('生徒データのパースエラー:', e);
            showError('生徒データの読み込みに失敗しました');
          }
        })
        .withFailureHandler(function(error) {
          console.error('生徒一覧の取得エラー:', error);
          showError('生徒一覧の取得に失敗しました');

          // エラー時もローディングを解除
          hideLoadingOnStrategyInput();
        })
        .getStudentsList();
    }

    // ページ読み込み時の初期化
    window.onload = function() {
      google.script.run
        .withSuccessHandler(updatePage)
        .withFailureHandler(showError)
        .loadPage('Page-StrategyInput');
    };

    // ========================================
    // ユーティリティ
    // ========================================

    // Toast通知を表示
    function showToast(message, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => toast.classList.add('show'), 10);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, duration);
    }

    // エラー表示
    function showError(message) {
      console.error('エラー:', message);
      showToast('エラー: ' + message, 5000);
    }
  </script>
</body>
</html>
